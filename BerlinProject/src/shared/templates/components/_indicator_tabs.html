{#
    Indicator Charts Tabs Component

    A tabbed interface for displaying indicator analysis charts.
    Used by both Card Details (stock_analysis_ui) and Replay (visualization_apps).

    Usage:
        {% include 'shared/components/_indicator_tabs.html' %}

    Required JavaScript:
        - IndicatorCharts module from indicator-charts.js
        - Highcharts library

    Optional Jinja2 variables:
        - tabs_id: ID for the tabs container (default: "indicatorTabs")
        - contents_id: ID for the tab contents container (default: "indicatorTabContents")
        - section_id: ID for the outer section (default: "indicatorChartsSection")
        - chart_height: Height of each chart in pixels (default: 400)
        - title: Section title (default: "Indicator History Charts")
        - subtitle: Section subtitle (default: "Historical indicator values and trigger signals")
        - theme: Theme name for styling (default: "dark")
#}

{% set tabs_id = tabs_id | default("indicatorTabs") %}
{% set contents_id = contents_id | default("indicatorTabContents") %}
{% set section_id = section_id | default("indicatorChartsSection") %}
{% set chart_height = chart_height | default(400) %}
{% set title = title | default("Indicator History Charts") %}
{% set subtitle = subtitle | default("Historical indicator values and trigger signals") %}
{% set theme = theme | default("dark") %}

<div class="chart-section" id="{{ section_id }}">
    <div class="chart-section-header">
        <div>
            <h3 class="chart-section-title">{{ title }}</h3>
            <p class="chart-section-subtitle">{{ subtitle }}</p>
        </div>
    </div>

    {# Indicator Tabs Navigation #}
    <div class="indicator-tabs" id="{{ tabs_id }}">
        <div class="chart-loading">Loading indicator tabs...</div>
    </div>

    {# Tab Content Containers #}
    <div id="{{ contents_id }}">
        {# Tab content will be dynamically generated by JavaScript #}
    </div>
</div>

{# Tab switching function #}
<script>
(function() {
    // Sanitize indicator name for use as HTML ID (remove spaces, special chars)
    function sanitizeId(name) {
        return name.replace(/[^a-zA-Z0-9_-]/g, '_');
    }

    // Tab switching functionality
    window.switchIndicatorTab = function(indicatorName) {
        const tabsContainer = document.getElementById('{{ tabs_id }}');
        const contentsContainer = document.getElementById('{{ contents_id }}');

        if (!tabsContainer || !contentsContainer) return;

        const sanitizedName = sanitizeId(indicatorName);

        // Update tab active state
        tabsContainer.querySelectorAll('.indicator-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.indicator === indicatorName) {
                tab.classList.add('active');
            }
        });

        // Update content visibility
        contentsContainer.querySelectorAll('.indicator-tab-content').forEach(content => {
            content.classList.remove('active');
        });

        const targetContent = document.getElementById(`tab-${sanitizedName}`);
        if (targetContent) {
            targetContent.classList.add('active');
        }

        // Reflow chart if it exists in the registry
        const charts = window.indicatorCharts || {};
        if (charts[indicatorName] && typeof charts[indicatorName].reflow === 'function') {
            charts[indicatorName].reflow();
        }
    };

    // Function to render indicator tabs from data
    window.renderIndicatorTabs = function(indicatorHistory, classToLayout, componentHistory, rawIndicatorHistory) {
        const tabsContainer = document.getElementById('{{ tabs_id }}');
        const contentsContainer = document.getElementById('{{ contents_id }}');

        if (!tabsContainer || !contentsContainer) return;

        if (!indicatorHistory || Object.keys(indicatorHistory).length === 0) {
            tabsContainer.innerHTML = '<div class="chart-empty-state"><div class="chart-empty-state-text">No indicator history available</div></div>';
            return;
        }

        const indicatorNames = Object.keys(indicatorHistory);
        let tabsHtml = '';
        let contentsHtml = '';

        indicatorNames.forEach((name, index) => {
            const isActive = index === 0 ? ' active' : '';
            const displayName = name.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim();
            const sanitizedName = sanitizeId(name);  // Safe for HTML IDs

            tabsHtml += `
                <button class="indicator-tab${isActive}"
                        onclick="switchIndicatorTab('${name}')"
                        data-indicator="${name}">
                    ${displayName}
                </button>
            `;

            contentsHtml += `
                <div class="indicator-tab-content${isActive}" id="tab-${sanitizedName}">
                    <div class="indicator-chart-container" id="chart-${sanitizedName}" style="height: {{ chart_height }}px;">
                        <div class="chart-loading">Rendering ${displayName} chart...</div>
                    </div>
                </div>
            `;
        });

        tabsContainer.innerHTML = tabsHtml;
        contentsContainer.innerHTML = contentsHtml;

        // Render charts using IndicatorCharts module if available
        if (typeof window.IndicatorCharts?.createIndicatorCharts === 'function') {
            // Use the shared module to render all indicator charts
            indicatorNames.forEach((name, index) => {
                setTimeout(() => {
                    renderSingleIndicatorChart(name, indicatorHistory, classToLayout, componentHistory, rawIndicatorHistory);
                }, index * 50);  // Stagger chart creation
            });
        }
    };

    // Render a single indicator chart
    function renderSingleIndicatorChart(indicatorName, indicatorHistory, classToLayout, componentHistory, rawIndicatorHistory) {
        const sanitizedName = sanitizeId(indicatorName);
        const containerId = `chart-${sanitizedName}`;
        const container = document.getElementById(containerId);
        if (!container) return;

        const history = indicatorHistory[indicatorName];
        if (!history || history.length === 0) {
            container.innerHTML = '<div class="chart-empty-state"><div class="chart-empty-state-text">No data available</div></div>';
            return;
        }

        // Use IndicatorCharts module for chart creation
        // Function signatures:
        // - createMACDChart(indicatorName, componentHistory, chartId, chartsRegistry)
        // - createTriggerChart(indicatorName, rawIndicatorHistory, indicatorHistory, chartId, chartsRegistry)
        // - createGenericIndicatorChart(indicatorName, componentHistory, chartId, chartsRegistry)
        if (typeof window.IndicatorCharts !== 'undefined') {
            const chartsRegistry = window.indicatorCharts || {};
            const layout = classToLayout?.[indicatorName] || 'line';
            const values = history.map(p => p[1]).filter(v => v !== null);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const isTriggerChart = maxValue <= 1.5 && minValue >= 0;

            let chart;
            if (layout === 'stacked' && indicatorName.toLowerCase().includes('macd')) {
                chart = window.IndicatorCharts.createMACDChart(
                    indicatorName,
                    componentHistory || {},
                    containerId,
                    chartsRegistry
                );
            } else if (isTriggerChart) {
                chart = window.IndicatorCharts.createTriggerChart(
                    indicatorName,
                    rawIndicatorHistory || {},
                    indicatorHistory || {},
                    containerId,
                    chartsRegistry
                );
            } else {
                chart = window.IndicatorCharts.createGenericIndicatorChart(
                    indicatorName,
                    componentHistory || {},
                    containerId,
                    chartsRegistry
                );
            }

            if (chart) {
                window.indicatorCharts = window.indicatorCharts || {};
                window.indicatorCharts[indicatorName] = chart;
            }
        }
    }
})();
</script>
