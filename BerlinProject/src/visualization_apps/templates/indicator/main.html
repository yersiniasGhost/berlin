{% extends "base.html" %}

{% block title %}Indicator Visualization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>Indicator Visualization
            </h2>
        </div>
    </div>

    <!-- Configuration Panel -->
    <div class="row mb-4">
        <div class="col-md-4">
            <!-- Data Configuration Card -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>Data Configuration</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="dataTicker" class="form-label">Ticker Symbol</label>
                            <input type="text" class="form-control" id="dataTicker" placeholder="e.g., NVDA" value="NVDA">
                        </div>
                        <div class="col-6">
                            <label for="dataStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="dataStartDate">
                        </div>
                        <div class="col-6">
                            <label for="dataEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="dataEndDate">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="dataExtendedHours" checked>
                                <label class="form-check-label" for="dataExtendedHours">
                                    Include Extended Hours
                                </label>
                                <small class="form-text text-muted d-block">When unchecked, only uses data from 9:30 AM - 4:00 PM ET</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicator Selection Card -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Indicators</h6>
                </div>
                <div class="card-body">
                    <form id="indicatorForm">
                        <div class="mb-3">
                            <label class="form-label">Select Indicators</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="macdIndicator" checked>
                                <label class="form-check-label" for="macdIndicator">MACD</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="smaIndicator" checked>
                                <label class="form-check-label" for="smaIndicator">SMA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emaIndicator">
                                <label class="form-check-label" for="emaIndicator">EMA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="rsiIndicator">
                                <label class="form-check-label" for="rsiIndicator">RSI</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bollinger">
                                <label class="form-check-label" for="bollinger">Bollinger Bands</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Trigger Detection</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showTriggers" checked>
                                <label class="form-check-label" for="showTriggers">Show Trigger Events</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="calculateIndicators">
                                <i class="fas fa-calculator me-2"></i>Calculate Indicators
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Indicator Parameters -->
            <div class="card mt-3" id="parametersCard" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">Indicator Parameters</h6>
                </div>
                <div class="card-body">
                    <div id="indicatorParameters">
                        <!-- Dynamic parameter inputs will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Column -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Indicator Charts</h6>
                </div>
                <div class="card-body">
                    <div id="chartsContainer">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>Configure and calculate indicators to see charts</p>
                        </div>
                    </div>

                    <!-- Main candlestick chart -->
                    <div id="candlestickChart" style="height: 400px; margin-bottom: 20px; display: none;"></div>

                    <!-- Indicator charts container -->
                    <div id="indicatorChartsContainer" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trigger Events Table -->
    <div class="row" id="triggersSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Detected Trigger Events</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Indicator</th>
                                    <th>Trigger Type</th>
                                    <th>Value</th>
                                    <th>Price</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="triggersTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No trigger events detected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/config-utils.js') }}"></script>
<script>
// Default data configuration - uses shared getDefaultDataConfig() from config-utils.js
// DEFAULT_DATA_CONFIG is already defined globally in config-utils.js

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates dynamically (2 weeks ago to tomorrow)
    document.getElementById('dataStartDate').value = DEFAULT_DATA_CONFIG.start_date;
    document.getElementById('dataEndDate').value = DEFAULT_DATA_CONFIG.end_date;
    const calculateBtn = document.getElementById('calculateIndicators');
    const parametersCard = document.getElementById('parametersCard');
    const chartsContainer = document.getElementById('chartsContainer');
    const triggersSection = document.getElementById('triggersSection');

    let charts = {};
    let currentData = null;

    // Collect data configuration (matching optimizer pattern)
    function collectDataConfig() {
        return {
            ticker: document.getElementById('dataTicker').value.toUpperCase().trim(),
            start_date: document.getElementById('dataStartDate').value,
            end_date: document.getElementById('dataEndDate').value,
            include_extended_hours: document.getElementById('dataExtendedHours').checked
        };
    }

    // Gather selected indicators
    function gatherSelectedIndicators() {
        const selectedIndicators = [];

        if (document.getElementById('macdIndicator').checked) {
            selectedIndicators.push({
                name: 'MACDIndicator',
                display_name: 'MACD',
                parameters: { fast_period: 12, slow_period: 26, signal_period: 9 }
            });
        }
        if (document.getElementById('smaIndicator').checked) {
            selectedIndicators.push({
                name: 'SMAIndicator',
                display_name: 'SMA',
                parameters: { period: 20 }
            });
        }
        if (document.getElementById('emaIndicator').checked) {
            selectedIndicators.push({
                name: 'EMAIndicator',
                display_name: 'EMA',
                parameters: { period: 20 }
            });
        }
        if (document.getElementById('rsiIndicator').checked) {
            selectedIndicators.push({
                name: 'RSIIndicator',
                display_name: 'RSI',
                parameters: { period: 14 }
            });
        }
        if (document.getElementById('bollinger').checked) {
            selectedIndicators.push({
                name: 'BollingerBandsIndicator',
                display_name: 'Bollinger Bands',
                parameters: { period: 20, std_dev: 2.0 }
            });
        }

        return selectedIndicators;
    }

    // Validate form data
    function validateFormData(dataConfig, indicators) {
        if (indicators.length === 0) {
            showAlert('Please select at least one indicator to calculate', 'warning');
            return false;
        }

        if (!dataConfig.ticker) {
            showAlert('Please enter a ticker symbol', 'warning');
            return false;
        }

        if (!dataConfig.start_date || !dataConfig.end_date) {
            showAlert('Please select start and end dates', 'warning');
            return false;
        }

        // Validate date order
        if (new Date(dataConfig.start_date) >= new Date(dataConfig.end_date)) {
            showAlert('Start date must be before end date', 'warning');
            return false;
        }

        return true;
    }

    // Calculate indicators
    calculateBtn.addEventListener('click', async function() {
        const dataConfig = collectDataConfig();
        const indicators = gatherSelectedIndicators();

        if (!validateFormData(dataConfig, indicators)) {
            return;
        }

        try {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating...';

            const requestBody = {
                ticker: dataConfig.ticker,
                start_date: dataConfig.start_date,
                end_date: dataConfig.end_date,
                include_extended_hours: dataConfig.include_extended_hours,
                indicators: indicators,
                show_triggers: document.getElementById('showTriggers').checked
            };

            const response = await fetch('/indicator/api/visualize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const result = await response.json();

            if (result.success) {
                currentData = result.data;
                displayResults(result.data);
                showAlert(`Successfully calculated ${result.indicator_count} indicators with ${result.candle_count} candles`, 'success');
            } else {
                throw new Error(result.error || 'Calculation failed');
            }

        } catch (error) {
            showAlert(`Failed to calculate indicators: ${error.message}`, 'danger');
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-calculator me-2"></i>Calculate Indicators';
        }
    });

    function displayResults(data) {
        // Hide placeholder and show charts
        chartsContainer.querySelector('.text-center').style.display = 'none';
        document.getElementById('candlestickChart').style.display = 'block';
        document.getElementById('indicatorChartsContainer').style.display = 'block';

        // Create main price chart
        createCandlestickChart(data.candlestick);

        // Create indicator charts
        createIndicatorCharts(data.indicators);

        // Show trigger events if enabled
        if (data.triggers && data.triggers.length > 0) {
            displayTriggerEvents(data.triggers);
            triggersSection.style.display = 'block';
        }

        // Show parameters card
        parametersCard.style.display = 'block';
        displayIndicatorParameters(data.indicator_metadata);
    }

    function createCandlestickChart(priceData) {
        const chartConfig = {
            chart: {
                height: 400,
                zoomType: 'x'
            },
            title: { text: 'Price Chart' },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Price' } },
            series: [{
                name: 'Price',
                data: priceData,
                type: 'candlestick',
                color: '#dc3545',
                upColor: '#28a745'
            }],
            credits: { enabled: false }
        };

        if (charts.candlestick) {
            charts.candlestick.destroy();
        }
        charts.candlestick = Highcharts.chart('candlestickChart', chartConfig);
    }

    function createIndicatorCharts(indicators) {
        const container = document.getElementById('indicatorChartsContainer');
        container.innerHTML = '';

        Object.entries(indicators).forEach(([indicatorName, indicatorData]) => {
            const chartDiv = document.createElement('div');
            chartDiv.id = `${indicatorName}Chart`;
            chartDiv.style.height = '300px';
            chartDiv.style.marginBottom = '20px';

            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `<h6>${indicatorData.name || indicatorName.toUpperCase()}</h6>`;
            container.appendChild(titleDiv);
            container.appendChild(chartDiv);

            // Create chart based on indicator type
            const lowerName = indicatorName.toLowerCase();
            if (lowerName.includes('macd')) {
                createMACDChart(chartDiv.id, indicatorData);
            } else if (lowerName.includes('sma') || lowerName.includes('ema')) {
                createMovingAverageChart(chartDiv.id, indicatorData, indicatorData.name || indicatorName);
            } else if (lowerName.includes('rsi')) {
                createRSIChart(chartDiv.id, indicatorData);
            } else if (lowerName.includes('bollinger')) {
                createBollingerChart(chartDiv.id, indicatorData);
            } else {
                createGenericChart(chartDiv.id, indicatorData, indicatorData.name || indicatorName);
            }
        });
    }

    function createMACDChart(containerId, data) {
        charts[containerId] = Highcharts.chart(containerId, {
            chart: { height: 300 },
            title: { text: null },
            xAxis: { type: 'datetime' },
            yAxis: [{
                title: { text: 'MACD' },
                height: '60%'
            }, {
                title: { text: 'Histogram' },
                top: '65%',
                height: '35%'
            }],
            series: [{
                name: 'MACD',
                data: data.macd || data.data || [],
                yAxis: 0,
                color: '#007bff'
            }, {
                name: 'Signal',
                data: data.signal || [],
                yAxis: 0,
                color: '#dc3545'
            }, {
                name: 'Histogram',
                data: data.histogram || [],
                type: 'column',
                yAxis: 1,
                color: '#28a745'
            }],
            credits: { enabled: false }
        });
    }

    function createMovingAverageChart(containerId, data, title) {
        charts[containerId] = Highcharts.chart(containerId, {
            chart: { height: 300 },
            title: { text: null },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Value' } },
            series: [{
                name: title,
                data: data.data || data,
                color: '#007bff'
            }],
            credits: { enabled: false }
        });
    }

    function createRSIChart(containerId, data) {
        charts[containerId] = Highcharts.chart(containerId, {
            chart: { height: 300 },
            title: { text: null },
            xAxis: { type: 'datetime' },
            yAxis: {
                title: { text: 'RSI' },
                min: 0,
                max: 100,
                plotLines: [
                    { value: 70, color: '#dc3545', width: 1, dashStyle: 'dash' },
                    { value: 30, color: '#28a745', width: 1, dashStyle: 'dash' }
                ]
            },
            series: [{
                name: 'RSI',
                data: data.data || data,
                color: '#007bff'
            }],
            credits: { enabled: false }
        });
    }

    function createBollingerChart(containerId, data) {
        charts[containerId] = Highcharts.chart(containerId, {
            chart: { height: 300 },
            title: { text: null },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Value' } },
            series: [{
                name: 'Upper Band',
                data: data.upper || [],
                color: '#dc3545'
            }, {
                name: 'Middle Band',
                data: data.middle || data.data || [],
                color: '#007bff'
            }, {
                name: 'Lower Band',
                data: data.lower || [],
                color: '#28a745'
            }],
            credits: { enabled: false }
        });
    }

    function createGenericChart(containerId, data, title) {
        charts[containerId] = Highcharts.chart(containerId, {
            chart: { height: 300 },
            title: { text: null },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Value' } },
            series: [{
                name: title,
                data: data.data || data,
                color: '#007bff'
            }],
            credits: { enabled: false }
        });
    }

    function displayIndicatorParameters(indicatorMetadata) {
        const container = document.getElementById('indicatorParameters');
        let html = '';

        if (indicatorMetadata && indicatorMetadata.length > 0) {
            indicatorMetadata.forEach(indicator => {
                html += `
                    <div class="mb-3">
                        <h6>${indicator.display_name || indicator.name}</h6>
                        <ul class="list-unstyled">
                `;

                if (indicator.parameters) {
                    Object.entries(indicator.parameters).forEach(([param, value]) => {
                        html += `<li><strong>${param}:</strong> ${value}</li>`;
                    });
                }

                html += `</ul></div>`;
            });
        }

        container.innerHTML = html || '<p class="text-muted">No parameter details available</p>';
    }

    function displayTriggerEvents(triggers) {
        const tableBody = document.getElementById('triggersTable');

        if (!triggers || triggers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No trigger events detected</td></tr>';
            return;
        }

        const rows = triggers.map(trigger => {
            const triggerTypeClass = trigger.type === 'bullish' ? 'text-success' : 'text-danger';

            return `
                <tr>
                    <td>${new Date(trigger.timestamp).toLocaleDateString()}</td>
                    <td>${trigger.indicator}</td>
                    <td><span class="${triggerTypeClass}">${trigger.type}</span></td>
                    <td>${trigger.value.toFixed(4)}</td>
                    <td>$${trigger.price.toFixed(2)}</td>
                    <td>${trigger.description || '-'}</td>
                </tr>
            `;
        }).join('');

        tableBody.innerHTML = rows;
    }
});
</script>
{% endblock %}
