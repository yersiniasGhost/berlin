<!-- Reusable Configuration Editor Component -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>{{ editor_title | default("Configuration Editor") }}
        </h5>
        <div>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="validateConfigBtn">
                <i class="fas fa-check-circle me-1"></i>Validate
            </button>
            <button type="button" class="btn btn-success btn-sm" id="saveChangesBtn">
                <i class="fas fa-check me-1"></i>Save Changes
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="saveAsJsonBtn">
                <i class="fas fa-download me-1"></i>Save as New JSON
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Config Tabs -->
        <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
            {% for tab in config_tabs %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" 
                        id="{{ tab.key }}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#{{ tab.key }}-pane" 
                        type="button" 
                        role="tab">
                    <i class="{{ tab.icon }} me-1"></i>{{ tab.title }}
                </button>
            </li>
            {% endfor %}
        </ul>
        
        <!-- Config Tab Content -->
        <div class="tab-content" id="configTabContent">
            {% for tab in config_tabs %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="{{ tab.key }}-pane" 
                 role="tabpanel" 
                 aria-labelledby="{{ tab.key }}-tab">
                <div class="config-section" data-config-type="{{ tab.key }}">
                    <div class="form-container">
                        <!-- Dynamic form content will be inserted here -->
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-file-import fa-2x mb-2"></i>
                            <p>Load a configuration file to start editing</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Validation Results -->
        <div id="validationResults" class="mt-3" style="display: none;">
            <div class="alert alert-dismissible fade show" role="alert">
                <div id="validationContent"></div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const validateBtn = document.getElementById('validateConfigBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const saveAsJsonBtn = document.getElementById('saveAsJsonBtn');
    const validationResults = document.getElementById('validationResults');
    
    // Make currentConfigs globally accessible
    window.currentConfigs = {};
    
    // Listen for config loading events
    document.addEventListener('configsReady', function(event) {
        loadConfigurations(event.detail);
    });
    
    document.addEventListener('examplesLoaded', function(event) {
        loadExampleConfigurations(event.detail);
    });
    
    function loadConfigurations(filePaths) {
        const loadConfigsBtn = document.getElementById('loadConfigsBtn');
        
        fetch(`${window.location.pathname}/api/load_configs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filePaths)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.currentConfigs = {
                    monitor_config: data.monitor_config || data.ga_config,
                    ga_config: data.ga_config,
                    data_config: data.data_config
                };
                
                renderConfigurationForms();
                showAlert('Configurations loaded successfully', 'success');
            } else {
                throw new Error(data.error || 'Failed to load configurations');
            }
        })
        .catch(error => {
            showAlert(`Failed to load configurations: ${error.message}`, 'danger');
        })
        .finally(() => {
            if (loadConfigsBtn) {
                loadConfigsBtn.disabled = false;
                loadConfigsBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Load Configurations';
            }
        });
    }
    
    function loadExampleConfigurations(examples) {
        window.currentConfigs = examples;
        renderConfigurationForms();
    }
    
    function renderConfigurationForms() {
        Object.keys(window.currentConfigs).forEach(configType => {
            const container = document.querySelector(`[data-config-type="${configType}"] .form-container`);
            if (container && window.currentConfigs[configType]) {
                container.innerHTML = generateFormHTML(window.currentConfigs[configType], configType);
                attachFormHandlers(container, configType);
            }
        });
    }
    
    function generateFormHTML(config, configType) {
        if (configType === 'data_config') {
            return generateDataConfigForm(config);
        } else if (configType === 'monitor_config') {
            return generateMonitorConfigForm(config);
        } else if (configType === 'ga_config') {
            return generateGaConfigForm(config);
        }
        return '';
    }
    
    // ===== REUSABLE FORM GENERATION FUNCTIONS =====
    
    function createFormField(label, name, value, type = 'text', options = {}) {
        const fieldId = `${name}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const {placeholder = '', min, max, step, choices, description} = options;
        
        let inputHtml = '';
        
        switch (type) {
            case 'number':
                inputHtml = `<input type="number" class="form-control form-control-sm" id="${fieldId}" name="${name}" 
                    value="${value || 0}" ${min ? `min="${min}"` : ''} ${max ? `max="${max}"` : ''} 
                    ${step ? `step="${step}"` : ''} placeholder="${placeholder}" style="font-size: 0.875rem;">`;
                break;
            case 'select':
                const optionsHtml = choices.map(choice => 
                    `<option value="${choice.value || choice}" ${(value === (choice.value || choice)) ? 'selected' : ''}>
                        ${choice.label || choice}
                    </option>`
                ).join('');
                inputHtml = `<select class="form-select form-select-sm" id="${fieldId}" name="${name}" style="font-size: 0.875rem;">${optionsHtml}</select>`;
                break;
            case 'checkbox':
                inputHtml = `<div class="form-check">
                    <input type="checkbox" class="form-check-input" id="${fieldId}" name="${name}" 
                        ${value ? 'checked' : ''}>
                    <label class="form-check-label" for="${fieldId}" style="font-size: 0.875rem;">${label}</label>
                </div>`;
                return `<div class="col-md-6 mb-2">${inputHtml}</div>`;
            case 'textarea':
                inputHtml = `<textarea class="form-control form-control-sm" id="${fieldId}" name="${name}" rows="2" placeholder="${placeholder}" style="font-size: 0.875rem;">${value || ''}</textarea>`;
                break;
            default:
                inputHtml = `<input type="text" class="form-control form-control-sm" id="${fieldId}" name="${name}" 
                    value="${value || ''}" placeholder="${placeholder}" style="font-size: 0.875rem;">`;
        }
        
        return `
            <div class="col-md-6 mb-2">
                <label for="${fieldId}" class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">${label}</label>
                ${inputHtml}
            </div>
        `;
    }
    
    function createArrayField(label, name, values = [], itemType = 'text') {
        const containerId = `${name}_container_${Date.now()}`;
        
        let itemsHtml = '';
        values.forEach((value, index) => {
            if (typeof value === 'object') {
                itemsHtml += createObjectField(`${label} ${index + 1}`, `${name}[${index}]`, value);
            } else {
                itemsHtml += `
                    <div class="array-item mb-2 d-flex gap-2">
                        <input type="${itemType}" class="form-control" name="${name}[${index}]" value="${value || ''}">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeArrayItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
        });
        
        return `
            <div class="col-12 mb-4">
                <label class="form-label fw-bold">${label}</label>
                <div id="${containerId}" class="border rounded p-3">
                    ${itemsHtml}
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                        onclick="addArrayItem('${containerId}', '${name}', '${itemType}')">
                        <i class="fas fa-plus me-1"></i>Add ${label.slice(0, -1)}
                    </button>
                </div>
            </div>
        `;
    }
    
    function createObjectField(label, name, obj = {}, isCollapsible = true) {
        const fieldId = `${name}_${Date.now()}`;
        const collapseId = `collapse_${fieldId}`;
        
        let fieldsHtml = '';
        Object.keys(obj).forEach(key => {
            const value = obj[key];
            if (Array.isArray(value)) {
                fieldsHtml += createArrayField(key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
                    `${name}.${key}`, value);
            } else if (typeof value === 'object' && value !== null) {
                fieldsHtml += createObjectField(key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
                    `${name}.${key}`, value);
            } else {
                const fieldType = typeof value === 'number' ? 'number' : 
                                 typeof value === 'boolean' ? 'checkbox' : 'text';
                fieldsHtml += createFormField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    `${name}.${key}`,
                    value,
                    fieldType
                );
            }
        });
        
        if (isCollapsible) {
            return `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <button class="btn btn-link text-decoration-none w-100 text-start" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <i class="fas fa-chevron-down me-2"></i>${label}
                            </button>
                        </div>
                        <div class="collapse" id="${collapseId}">
                            <div class="card-body">
                                <div class="row g-3">
                                    ${fieldsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            return `
                <div class="col-12 mb-4">
                    <h6 class="fw-bold">${label}</h6>
                    <div class="border rounded p-3">
                        <div class="row g-3">
                            ${fieldsHtml}
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // Deep recursive function to create nested object fields
    function createDeepObjectFields(obj, basePath, level = 0, sectionType = '') {
        let fieldsHtml = '';
        
        Object.keys(obj).forEach(key => {
            const value = obj[key];
            const fieldPath = `${basePath}.${key}`;
            
            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                // Special handling for bars section - don't create sub-panels for "indicators"
                if (sectionType === 'bars' && key === 'indicators') {
                    // Just show indicator weights directly
                    fieldsHtml += `<div class="col-12 mb-2"><h6 class="fw-bold mb-1">Indicator Weights</h6>`;
                    Object.keys(value).forEach(indicatorKey => {
                        const indicatorValue = value[indicatorKey];
                        fieldsHtml += createFormField(
                            indicatorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            `${fieldPath}.${indicatorKey}`,
                            indicatorValue,
                            'number'
                        );
                    });
                    fieldsHtml += `</div>`;
                } else {
                    // Complex nested object - create a sub-panel
                    const subPanelId = `${basePath.replace(/\./g, '_')}_${key}_${Date.now()}`;
                    const subCollapseId = `collapse_${subPanelId}`;
                    
                    const nestedFields = createDeepObjectFields(value, fieldPath, level + 1, sectionType);
                    
                    fieldsHtml += `
                        <div class="col-12 mb-2">
                            <div class="card border-secondary">
                                <div class="card-header py-1">
                                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#${subCollapseId}">
                                        <i class="fas fa-chevron-down me-2"></i><small class="fw-bold">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</small>
                                    </button>
                                </div>
                                <div class="collapse" id="${subCollapseId}">
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            ${nestedFields}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (Array.isArray(value)) {
                // Handle arrays
                fieldsHtml += `<div class="col-12 mb-2"><h6 class="fw-bold mb-1">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6>`;
                value.forEach((item, index) => {
                    if (typeof item === 'object' && item !== null) {
                        fieldsHtml += createDeepObjectFields(item, `${fieldPath}[${index}]`, level + 1, sectionType);
                    } else {
                        const fieldType = typeof item === 'number' ? 'number' : 'text';
                        fieldsHtml += createFormField(
                            `${key} ${index + 1}`,
                            `${fieldPath}[${index}]`,
                            item,
                            fieldType
                        );
                    }
                });
                fieldsHtml += `</div>`;
            } else {
                // Simple field
                const fieldType = typeof value === 'number' ? 'number' :
                                 typeof value === 'boolean' ? 'checkbox' : 'text';
                fieldsHtml += createFormField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    fieldPath,
                    value,
                    fieldType
                );
            }
        });
        
        return fieldsHtml;
    }
    
    // Special function for objectives - array of {objective, weight} objects
    function createObjectivesPanel(objectives, sectionKey) {
        const panelId = `${sectionKey}_panel_${Date.now()}`;
        const collapseId = `collapse_${panelId}`;
        
        let fieldsHtml = '';
        
        if (Array.isArray(objectives)) {
            objectives.forEach((obj, index) => {
                fieldsHtml += `
                    <div class="col-12 mb-2">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <input type="text" class="form-control form-control-sm" name="${sectionKey}[${index}].objective" value="${obj.objective || ''}" placeholder="Objective name" style="font-size: 0.875rem;">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control form-control-sm" name="${sectionKey}[${index}].weight" value="${obj.weight || 1.0}" step="0.1" style="font-size: 0.875rem;">
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Add button to add new objectives
        fieldsHtml += `
            <div class="col-12">
                <button type="button" class="btn btn-outline-primary btn-sm mt-1" onclick="addObjective('${sectionKey}')">
                    <i class="fas fa-plus me-1"></i>Add Objective
                </button>
            </div>
        `;
        
        return `
            <div class="card mb-2">
                <div class="card-header py-2">
                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                        <i class="fas fa-chevron-down me-2"></i><strong>Objectives</strong>
                    </button>
                </div>
                <div class="collapse" id="${collapseId}">
                    <div class="card-body py-2">
                        ${fieldsHtml}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Simple section panel for stacked layout
    function createSectionPanel(title, sectionKey, sectionData) {
        const panelId = `${sectionKey}_panel_${Date.now()}`;
        const collapseId = `collapse_${panelId}`;
        
        let fieldsHtml = '';
        
        if (Array.isArray(sectionData)) {
            // Handle arrays
            sectionData.forEach((item, index) => {
                if (typeof item === 'object' && item !== null) {
                    fieldsHtml += createDeepObjectFields(item, `${sectionKey}[${index}]`, 0, sectionKey);
                } else {
                    const fieldType = typeof item === 'number' ? 'number' : 'text';
                    fieldsHtml += createFormField(
                        `Item ${index + 1}`,
                        `${sectionKey}[${index}]`,
                        item,
                        fieldType
                    );
                }
            });
        } else if (typeof sectionData === 'object' && sectionData !== null) {
            // Use deep parsing for complex objects, pass section type for special handling
            const sectionType = sectionKey.includes('bars') ? 'bars' : sectionKey;
            fieldsHtml = createDeepObjectFields(sectionData, sectionKey, 0, sectionType);
        }
        
        return `
            <div class="card mb-2">
                <div class="card-header py-2">
                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                        <i class="fas fa-chevron-down me-2"></i><strong>${title}</strong>
                    </button>
                </div>
                <div class="collapse" id="${collapseId}">
                    <div class="card-body py-2">
                        <div class="row g-2">
                            ${fieldsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Special indicators panel with individual indicator sub-panels
    function createIndicatorsPanel(indicators, sectionKey) {
        const panelId = `${sectionKey}_panel_${Date.now()}`;
        const collapseId = `collapse_${panelId}`;
        
        let indicatorsHtml = '';
        
        if (Array.isArray(indicators)) {
            indicators.forEach((indicator, index) => {
                const indicatorName = indicator.name || `Indicator ${index + 1}`;
                const subPanelId = `indicator_${index}_${Date.now()}`;
                const subCollapseId = `collapse_${subPanelId}`;
                
                // Use deep object parsing for all indicator fields
                const indicatorFieldsHtml = createDeepObjectFields(indicator, `${sectionKey}[${index}]`);
                
                indicatorsHtml += `
                    <div class="card mb-1">
                        <div class="card-header py-1">
                            <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#${subCollapseId}">
                                <i class="fas fa-chevron-down me-2"></i><small>${indicatorName}</small>
                            </button>
                        </div>
                        <div class="collapse" id="${subCollapseId}">
                            <div class="card-body py-2">
                                <div class="row g-2">
                                    ${indicatorFieldsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        return `
            <div class="card mb-2">
                <div class="card-header py-2">
                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                        <i class="fas fa-chevron-down me-2"></i><strong>Indicators</strong>
                    </button>
                </div>
                <div class="collapse" id="${collapseId}">
                    <div class="card-body py-2">
                        ${indicatorsHtml}
                        <button type="button" class="btn btn-outline-primary btn-sm mt-1" onclick="addIndicator()">
                            <i class="fas fa-plus me-1"></i>Add Indicator
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function generateDataConfigForm(config) {
        let html = '<div class="row g-3">';
        
        // Define specific field order for data config (start_date before end_date)
        const fieldOrder = ['ticker', 'start_date', 'end_date'];
        const remainingKeys = Object.keys(config).filter(key => !fieldOrder.includes(key));
        const orderedKeys = [...fieldOrder, ...remainingKeys];
        
        // Generate fields in the specified order
        orderedKeys.forEach(key => {
            if (!config.hasOwnProperty(key)) return; // Skip if key doesn't exist
            
            const value = config[key];
            if (Array.isArray(value)) {
                html += createArrayField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
                    key, 
                    value
                );
            } else if (typeof value === 'object' && value !== null) {
                html += createObjectField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
                    key, 
                    value
                );
            } else {
                const fieldType = key.includes('date') ? 'date' :
                                 typeof value === 'number' ? 'number' :
                                 typeof value === 'boolean' ? 'checkbox' : 'text';
                const placeholder = key === 'ticker' ? 'e.g., NVDA' : '';
                html += createFormField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    key,
                    value,
                    fieldType,
                    { placeholder }
                );
            }
        });
        
        html += '</div>';
        return html;
    }
    
    function generateMonitorConfigForm(config) {
        let html = '';
        
        // Create stacked collapsible panels for each major section
        const sectionOrder = ['monitor', 'enter_long', 'exit_long', 'bars', 'trade_executor', 'indicators'];
        
        // Handle top-level fields first (like test_name)
        Object.keys(config).forEach(key => {
            if (!sectionOrder.includes(key)) {
                const value = config[key];
                const fieldType = typeof value === 'number' ? 'number' :
                                 typeof value === 'boolean' ? 'checkbox' : 'text';
                html += `<div class="mb-2">${createFormField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    key,
                    value,
                    fieldType
                )}</div>`;
            }
        });
        
        // Create panels for each major section - handle nested objects within monitor
        if (config.monitor) {
            const monitor = config.monitor;
            
            // Create monitor panel (excluding nested objects that get their own panels)
            const monitorFields = {};
            Object.keys(monitor).forEach(key => {
                if (!['enter_long', 'exit_long', 'bars', 'trade_executor'].includes(key)) {
                    monitorFields[key] = monitor[key];
                }
            });
            if (Object.keys(monitorFields).length > 0) {
                html += createSectionPanel('Monitor', 'monitor', monitorFields);
            }
            
            // Create separate panels for nested objects
            if (monitor.enter_long) {
                html += createSectionPanel('Enter Long', 'monitor.enter_long', monitor.enter_long);
            }
            if (monitor.exit_long) {
                html += createSectionPanel('Exit Long', 'monitor.exit_long', monitor.exit_long);
            }
            if (monitor.bars) {
                html += createSectionPanel('Bars', 'monitor.bars', monitor.bars);
            }
            if (monitor.trade_executor) {
                html += createSectionPanel('Trade Executor', 'monitor.trade_executor', monitor.trade_executor);
            }
        }
        
        // Handle direct top-level sections
        ['enter_long', 'exit_long', 'bars', 'trade_executor'].forEach(sectionKey => {
            if (config[sectionKey]) {
                html += createSectionPanel(
                    sectionKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    sectionKey,
                    config[sectionKey]
                );
            }
        });
        
        // Handle indicators last
        if (config.indicators) {
            html += createIndicatorsPanel(config.indicators, 'indicators');
        }
        
        return html;
    }
    
    function generateGaConfigForm(config) {
        let html = '';
        
        // Create stacked collapsible panels for each major section
        const sectionOrder = ['monitor', 'enter_long', 'exit_long', 'bars', 'trade_executor', 'indicators'];
        const specialSections = ['genetic_algorithm_config', 'objectives', 'ga_hyperparameters'];
        
        // Handle GA hyperparameters section
        if (config.ga_hyperparameters) {
            html += createSectionPanel('GA Hyperparameters', 'ga_hyperparameters', config.ga_hyperparameters);
        }
        
        // Handle other top-level fields (like test_name, etc.)
        Object.keys(config).forEach(key => {
            if (!sectionOrder.includes(key) && !specialSections.includes(key)) {
                const value = config[key];
                const fieldType = typeof value === 'number' ? 'number' :
                                 typeof value === 'boolean' ? 'checkbox' : 'text';
                html += `<div class="mb-2">${createFormField(
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    key,
                    value,
                    fieldType
                )}</div>`;
            }
        });
        
        // Create panels for each major section - handle nested objects within monitor
        if (config.monitor) {
            const monitor = config.monitor;
            
            // Create monitor panel (excluding nested objects that get their own panels)
            const monitorFields = {};
            Object.keys(monitor).forEach(key => {
                if (!['enter_long', 'exit_long', 'bars', 'trade_executor'].includes(key)) {
                    monitorFields[key] = monitor[key];
                }
            });
            if (Object.keys(monitorFields).length > 0) {
                html += createSectionPanel('Monitor', 'monitor', monitorFields);
            }
            
            // Create separate panels for nested objects
            if (monitor.enter_long) {
                html += createSectionPanel('Enter Long', 'monitor.enter_long', monitor.enter_long);
            }
            if (monitor.exit_long) {
                html += createSectionPanel('Exit Long', 'monitor.exit_long', monitor.exit_long);
            }
            if (monitor.bars) {
                html += createSectionPanel('Bars', 'monitor.bars', monitor.bars);
            }
            if (monitor.trade_executor) {
                html += createSectionPanel('Trade Executor', 'monitor.trade_executor', monitor.trade_executor);
            }
        }
        
        // Handle direct top-level sections
        ['enter_long', 'exit_long', 'bars', 'trade_executor'].forEach(sectionKey => {
            if (config[sectionKey]) {
                html += createSectionPanel(
                    sectionKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    sectionKey,
                    config[sectionKey]
                );
            }
        });
        
        // Handle special sections
        if (config.indicators) {
            html += createIndicatorsPanel(config.indicators, 'indicators');
        }
        if (config.genetic_algorithm_config) {
            html += createSectionPanel('GA Configuration', 'genetic_algorithm_config', config.genetic_algorithm_config);
        }
        if (config.objectives) {
            html += createObjectivesPanel(config.objectives, 'objectives');
        }
        
        return html;
    }
    
    function generateIndicatorForm(indicator, index) {
        // This function is no longer needed as indicators are handled by createIndicatorsPanel
        // Keep for backward compatibility
        const indicatorName = indicator.name || `Indicator ${index + 1}`;
        return createObjectField(
            indicatorName,
            `indicators[${index}]`,
            indicator,
            true
        );
    }
    
    // Global functions for onclick handlers
    window.addIndicator = function() {
        const activeTabPane = document.querySelector('.tab-pane.show.active');
        const indicatorsContainer = activeTabPane.querySelector('#indicatorsContainer');
        if (indicatorsContainer) {
            const newIndex = indicatorsContainer.children.length;
            const newIndicator = {
                name: `indicator_${newIndex + 1}`,
                function: '',
                type: 'trigger',
                parameters: {}
            };
            
            indicatorsContainer.insertAdjacentHTML('beforeend', generateIndicatorForm(newIndicator, newIndex));
            
            // Update the config from form
            const configSection = activeTabPane.querySelector('.config-section');
            const configType = configSection.dataset.configType;
            updateConfigFromForm(configType, null);
        }
    };
    
    window.removeIndicator = function(index) {
        const indicatorElement = document.querySelector(`.border[data-index="${index}"]`);
        if (indicatorElement) {
            indicatorElement.remove();
            
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            const configSection = activeTabPane.querySelector('.config-section');
            const configType = configSection.dataset.configType;
            updateConfigFromForm(configType, null);
        }
    };
    
    // Dynamic array management functions
    window.addArrayItem = function(containerId, name, itemType) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const button = container.querySelector('button');
        const itemCount = container.querySelectorAll('.array-item').length;
        
        let newItemHtml = '';
        if (itemType === 'object') {
            newItemHtml = `
                <div class="array-item mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Item ${itemCount + 1}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeArrayItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-12">
                                    <textarea class="form-control" name="${name}[${itemCount}]" placeholder="JSON object..." rows="3">{}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            newItemHtml = `
                <div class="array-item mb-2 d-flex gap-2">
                    <input type="${itemType}" class="form-control" name="${name}[${itemCount}]" value="">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeArrayItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
        
        button.insertAdjacentHTML('beforebegin', newItemHtml);
        
        // Update config
        const activeTabPane = document.querySelector('.tab-pane.show.active');
        const configSection = activeTabPane.querySelector('.config-section');
        const configType = configSection.dataset.configType;
        updateConfigFromForm(configType, null);
    };
    
    window.removeArrayItem = function(button) {
        const arrayItem = button.closest('.array-item');
        if (arrayItem) {
            arrayItem.remove();
            
            // Update config
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            const configSection = activeTabPane.querySelector('.config-section');
            const configType = configSection.dataset.configType;
            updateConfigFromForm(configType, null);
        }
    };
    
    // Object field management
    window.addObjectField = function(containerId, parentName) {
        const fieldName = prompt('Enter field name:');
        if (!fieldName) return;
        
        const fieldValue = prompt('Enter field value (leave empty for string):');
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const fieldType = !isNaN(fieldValue) && fieldValue !== '' ? 'number' : 'text';
        const newFieldHtml = createFormField(
            fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            `${parentName}.${fieldName}`,
            fieldValue || '',
            fieldType
        );
        
        const button = container.querySelector('button');
        if (button) {
            button.insertAdjacentHTML('beforebegin', newFieldHtml);
        } else {
            container.insertAdjacentHTML('beforeend', newFieldHtml);
        }
        
        // Update config
        const activeTabPane = document.querySelector('.tab-pane.show.active');
        const configSection = activeTabPane.querySelector('.config-section');
        const configType = configSection.dataset.configType;
        updateConfigFromForm(configType, null);
    };
    
    // Objectives management
    window.addObjective = function(sectionKey) {
        const activeTabPane = document.querySelector('.tab-pane.show.active');
        const objectivesPanel = activeTabPane.querySelector(`[data-bs-target*="collapse_${sectionKey}"]`);
        if (!objectivesPanel) return;
        
        const cardBody = objectivesPanel.closest('.card').querySelector('.card-body');
        const addButton = cardBody.querySelector('button');
        const objectiveCount = cardBody.querySelectorAll('.row.align-items-center').length;
        
        const newObjectiveHtml = `
            <div class="col-12 mb-2">
                <div class="row align-items-center">
                    <div class="col-8">
                        <input type="text" class="form-control form-control-sm" name="${sectionKey}[${objectiveCount}].objective" value="" placeholder="Objective name" style="font-size: 0.875rem;">
                    </div>
                    <div class="col-4">
                        <input type="number" class="form-control form-control-sm" name="${sectionKey}[${objectiveCount}].weight" value="1.0" step="0.1" style="font-size: 0.875rem;">
                    </div>
                </div>
            </div>
        `;
        
        addButton.insertAdjacentHTML('beforebegin', newObjectiveHtml);
        
        // Update config
        const configSection = activeTabPane.querySelector('.config-section');
        const configType = configSection.dataset.configType;
        updateConfigFromForm(configType, null);
    };
    
    function attachFormHandlers(container, configType) {
        // Handle form input changes
        container.addEventListener('input', function(e) {
            updateConfigFromForm(configType, e.target);
        });
        
        container.addEventListener('change', function(e) {
            updateConfigFromForm(configType, e.target);
        });
    }
    
    function updateConfigFromForm(configType, changedElement = null) {
        const container = document.querySelector(`[data-config-type="${configType}"] .form-container`);
        if (!container) return;
        
        const formData = new FormData();
        
        // Collect form data
        container.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) {
                if (input.type === 'checkbox') {
                    formData.append(input.name, input.checked ? 'true' : 'false');
                } else {
                    formData.append(input.name, input.value);
                }
            }
        });
        
        // Update config object
        window.currentConfigs[configType] = convertFormDataToConfig(formData, configType);
    }
    
    function convertFormDataToConfig(formData, configType) {
        const config = {};
        
        for (let [key, value] of formData.entries()) {
            if (value === 'true') {
                value = true;
            } else if (value === 'false') {
                value = false;
            } else if (value !== '' && !isNaN(value)) {
                value = parseFloat(value);
            }
            
            setNestedProperty(config, key, value);
        }
        
        // Post-process objectives array to ensure proper structure
        if (config.objectives && Array.isArray(config.objectives)) {
            config.objectives = config.objectives.filter(obj => obj && (obj.objective || obj.weight));
        }
        
        return config;
    }
    
    function setNestedProperty(obj, path, value) {
        const keys = path.split(/[\.\[\]]+/).filter(key => key);
        let current = obj;
        
        for (let i = 0; i < keys.length - 1; i++) {
            const key = keys[i];
            if (!current[key]) {
                current[key] = isNaN(keys[i + 1]) ? {} : [];
            }
            current = current[key];
        }
        
        const lastKey = keys[keys.length - 1];
        current[lastKey] = value;
    }
    
    // Validation handler
    if (validateBtn) {
        validateBtn.addEventListener('click', function() {
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            const configType = activeTabPane.querySelector('.config-section').dataset.configType;
            
            if (!window.currentConfigs[configType]) {
                showAlert('No configuration to validate', 'warning');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating...';
            
            fetch(`${window.location.pathname}/api/validate_config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    config_data: window.currentConfigs[configType],
                    config_type: configType
                })
            })
            .then(response => response.json())
            .then(data => {
                showValidationResults(data);
            })
            .catch(error => {
                showAlert(`Validation failed: ${error.message}`, 'danger');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-circle me-1"></i>Validate';
            });
        });
    }
    
    function showValidationResults(data) {
        const resultsDiv = document.getElementById('validationResults');
        const contentDiv = document.getElementById('validationContent');
        
        let content = `<h6>${data.message}</h6>`;
        
        if (data.errors && data.errors.length > 0) {
            content += '<div class="mb-2"><strong>Errors:</strong><ul class="mb-0">';
            data.errors.forEach(error => {
                content += `<li class="text-danger">${error}</li>`;
            });
            content += '</ul></div>';
        }
        
        contentDiv.innerHTML = content;
        resultsDiv.style.display = 'block';
        resultsDiv.querySelector('.alert').className = `alert alert-${data.success ? 'success' : 'danger'} alert-dismissible fade show`;
    }
    
    // Save Changes button
    if (saveChangesBtn) {
        saveChangesBtn.addEventListener('click', function() {
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            const configType = activeTabPane.querySelector('.config-section').dataset.configType;
            
            if (!window.currentConfigs[configType]) {
                showAlert('No configuration to save', 'warning');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            
            fetch(`${window.location.pathname}/api/save_config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    config_type: configType,
                    config_data: window.currentConfigs[configType]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Changes saved successfully!', 'success');
                } else {
                    showAlert(`Failed to save configuration: ${data.error || 'Unknown error'}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`Error saving configuration: ${error.message}`, 'danger');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check me-1"></i>Save Changes';
            });
        });
    }
    
    // Save as JSON button
    if (saveAsJsonBtn) {
        saveAsJsonBtn.addEventListener('click', function() {
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            const configType = activeTabPane.querySelector('.config-section').dataset.configType;
            
            if (!window.currentConfigs[configType]) {
                showAlert('No configuration to save', 'warning');
                return;
            }
            
            const configData = window.currentConfigs[configType];
            const jsonString = JSON.stringify(configData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `${configType}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            showAlert('Configuration downloaded as JSON file!', 'success');
        });
    }
});
</script>