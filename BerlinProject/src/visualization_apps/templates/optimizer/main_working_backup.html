{% extends "base.html" %}

{% block title %}Optimizer Visualization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-dna me-2"></i>Optimizer Visualization
            </h2>
        </div>
    </div>
    
    <!-- Configuration Section -->
    <div class="row">
        <div class="col-12">
            {% set file_types = [
                {'key': 'ga_config', 'title': 'GA Configuration', 'description': 'Upload your genetic algorithm configuration JSON file'},
                {'key': 'data_config', 'title': 'Data Configuration', 'description': 'Upload your data configuration JSON file'}
            ] %}
            {% include 'components/file_upload.html' %}
        </div>
    </div>
    
    <!-- Configuration Editor -->
    <div class="row">
        <div class="col-12">
            {% set config_tabs = [
                {'key': 'ga_config', 'title': 'GA Config', 'icon': 'fas fa-dna'},
                {'key': 'data_config', 'title': 'Data Config', 'icon': 'fas fa-database'}
            ] %}
            {% include 'components/config_editor.html' %}
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <button type="button" class="btn btn-success btn-lg me-3" id="startOptimizerBtn" disabled>
                                <i class="fas fa-play me-2"></i>Start Optimization
                            </button>
                            <button type="button" class="btn btn-warning btn-lg me-3" id="pauseOptimizerBtn" disabled>
                                <i class="fas fa-pause me-2"></i>Pause
                            </button>
                            <button type="button" class="btn btn-danger btn-lg" id="stopOptimizerBtn" disabled>
                                <i class="fas fa-stop me-2"></i>Stop
                            </button>
                        </div>
                        <div class="col-md-4">
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar" id="optimizationProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progressText">Ready</span>
                                </div>
                            </div>
                            <small class="text-muted" id="optimizationStatus">Generation: 0 / 0</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row" id="chartsSection" style="display: none;">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Objective Evolution</h6>
                </div>
                <div class="card-body">
                    <div id="objectiveChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Elite Population - Parallel Coordinates</h6>
                </div>
                <div class="card-body">
                    <div id="parallelCoordsChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0 text-success">Winning Trades Distribution</h6>
                </div>
                <div class="card-body">
                    <div id="winningTradesChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0 text-danger">Losing Trades Distribution</h6>
                </div>
                <div class="card-body">
                    <div id="losingTradesChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Current Best Strategy</h6>
                </div>
                <div class="card-body">
                    <div id="bestStrategyChart" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics Table -->
    <div class="row" id="metricsSection" style="display: none;">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Generation Performance Metrics</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Gen</th>
                                    <th>Total Trades</th>
                                    <th>Winning</th>
                                    <th>Losing</th>
                                    <th>Total P&L (%)</th>
                                    <th>Avg Win (%)</th>
                                    <th>Avg Loss (%)</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No performance data yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startOptimizerBtn = document.getElementById('startOptimizerBtn');
    const pauseOptimizerBtn = document.getElementById('pauseOptimizerBtn');
    const stopOptimizerBtn = document.getElementById('stopOptimizerBtn');
    const chartsSection = document.getElementById('chartsSection');
    const elitesSection = document.getElementById('elitesSection');
    
    let charts = {};
    let optimizationRunning = false;
    let pollInterval = null;
    
    // Initialize WebSocket connection
    function initializeWebSocket() {
        window.socket = io();
        
        window.socket.on('optimization_started', function(data) {
            showAlert('Optimization started successfully!', 'success');
            console.log('Optimization started:', data);
        });
        
        window.socket.on('generation_complete', function(data) {
            console.log('Generation complete:', data.generation);
            updateProgressBar(data);
            updateCharts(data.optimizer_charts || data.chart_data || {});
        });
        
        window.socket.on('optimization_complete', function(data) {
            showAlert('Optimization completed!', 'success');
            optimizationRunning = false;
            resetButtons();
            stopPolling();
        });
        
        window.socket.on('optimization_error', function(data) {
            showAlert(`Optimization error: ${data.error}`, 'danger');
            resetButtons();
        });
        
        window.socket.on('optimization_paused', function(data) {
            showAlert('Optimization paused', 'info');
        });
        
        window.socket.on('optimization_resumed', function(data) {
            showAlert('Optimization resumed', 'info');
        });
        
        window.socket.on('optimization_stopped', function(data) {
            showAlert('Optimization stopped', 'warning');
            resetButtons();
            stopPolling();
        });
    }
    
    // Initialize WebSocket on page load
    initializeWebSocket();
    
    // Listen for config changes to enable/disable start button
    document.addEventListener('configsReady', function() {
        startOptimizerBtn.disabled = false;
    });
    
    document.addEventListener('examplesLoaded', function() {
        startOptimizerBtn.disabled = false;
    });
    
    // Start optimization
    startOptimizerBtn.addEventListener('click', async function() {
        if (!window.currentConfigs || !window.currentConfigs.ga_config || !window.currentConfigs.data_config) {
            showAlert('Please load both GA and data configurations first', 'warning');
            return;
        }
        
        try {
            this.disabled = true;
            pauseOptimizerBtn.disabled = false;
            stopOptimizerBtn.disabled = false;
            
            const response = await fetch('/optimizer/api/start_optimization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ga_config: window.currentConfigs.ga_config,
                    data_config: window.currentConfigs.data_config
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                optimizationRunning = true;
                showAlert('Configurations prepared, starting optimization...', 'info');
                
                // Now trigger the WebSocket to actually start the optimization
                if (window.socket) {
                    window.socket.emit('start_optimization', {
                        ga_config_path: result.ga_config_path,
                        data_config_path: result.data_config_path
                    });
                } else {
                    // Initialize socket if not already done
                    initializeWebSocket();
                    setTimeout(() => {
                        window.socket.emit('start_optimization', {
                            ga_config_path: result.ga_config_path,
                            data_config_path: result.data_config_path
                        });
                    }, 100);
                }
                
                startPolling();
                showCharts();
            } else {
                throw new Error(result.error || 'Failed to start optimization');
            }
            
        } catch (error) {
            showAlert(`Failed to start optimization: ${error.message}`, 'danger');
            resetButtons();
        }
    });
    
    // Pause optimization
    pauseOptimizerBtn.addEventListener('click', async function() {
        try {
            const response = await fetch('/optimizer/api/pause_optimization', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                optimizationRunning = false;
                this.disabled = true;
                startOptimizerBtn.disabled = false;
                showAlert('Optimization paused', 'info');
                stopPolling();
            } else {
                throw new Error(result.error || 'Failed to pause optimization');
            }
            
        } catch (error) {
            showAlert(`Failed to pause optimization: ${error.message}`, 'danger');
        }
    });
    
    // Stop optimization
    stopOptimizerBtn.addEventListener('click', async function() {
        try {
            const response = await fetch('/optimizer/api/stop_optimization', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Optimization stopped', 'warning');
                resetButtons();
                stopPolling();
            } else {
                throw new Error(result.error || 'Failed to stop optimization');
            }
            
        } catch (error) {
            showAlert(`Failed to stop optimization: ${error.message}`, 'danger');
        }
    });
    
    function resetButtons() {
        startOptimizerBtn.disabled = false;
        pauseOptimizerBtn.disabled = true;
        stopOptimizerBtn.disabled = true;
        optimizationRunning = false;
    }
    
    function showCharts() {
        chartsSection.style.display = 'block';
        document.getElementById('metricsSection').style.display = 'block';
        initializeCharts();
    }
    
    function initializeCharts() {
        // Initialize empty charts
        charts.objective = Highcharts.chart('objectiveChart', {
            chart: { type: 'line' },
            title: { text: 'Objective Evolution' },
            xAxis: { title: { text: 'Generation' } },
            yAxis: { title: { text: 'Objective Value' } },
            series: [], // Will be dynamically populated
            credits: { enabled: false },
            legend: { enabled: true }
        });
        
        // Initialize parallel coordinates chart (like old app)
        charts.parallelCoords = Highcharts.chart('parallelCoordsChart', {
            chart: {
                type: 'line',
                parallelCoordinates: true,
                parallelAxes: {
                    lineWidth: 2,
                    gridlinesWidth: 1
                }
            },
            title: { text: 'Elite Population Analysis' },
            plotOptions: {
                series: {
                    animation: { duration: 500 },
                    lineWidth: 2.5,
                    opacity: 0.75,
                    marker: { enabled: false }
                }
            },
            legend: { enabled: false },
            credits: { enabled: false }
        });
        
        // Initialize winning trades distribution chart
        charts.winningTrades = Highcharts.chart('winningTradesChart', {
            chart: { type: 'column' },
            title: { text: 'Winning Trades Distribution' },
            xAxis: { 
                title: { text: 'Percentage Gain (%)' },
                categories: []
            },
            yAxis: { 
                title: { text: 'Number of Trades' },
                min: 0 
            },
            series: [{
                name: 'Winning Trades',
                data: [],
                color: '#28a745'
            }],
            credits: { enabled: false }
        });

        // Initialize losing trades distribution chart
        charts.losingTrades = Highcharts.chart('losingTradesChart', {
            chart: { type: 'column' },
            title: { text: 'Losing Trades Distribution' },
            xAxis: { 
                title: { text: 'Percentage Loss (%)' },
                categories: []
            },
            yAxis: { 
                title: { text: 'Number of Trades' },
                min: 0 
            },
            series: [{
                name: 'Losing Trades',
                data: [],
                color: '#dc3545'
            }],
            credits: { enabled: false }
        });
        
        charts.bestStrategy = Highcharts.chart('bestStrategyChart', {
            chart: { type: 'candlestick' },
            title: { text: 'Best Strategy Performance' },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Price' } },
            series: [{
                name: 'Price',
                data: []
            }],
            credits: { enabled: false }
        });
    }
    
    function startPolling() {
        pollInterval = setInterval(updateProgress, 2000); // Poll every 2 seconds
    }
    
    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    async function updateProgress() {
        try {
            const response = await fetch('/optimizer/api/get_progress');
            const data = await response.json();
            
            if (data.success) {
                updateProgressBar(data.progress);
                updateCharts(data.charts);
                updateElitesTable(data.elites);
                
                if (data.progress.completed) {
                    showAlert('Optimization completed!', 'success');
                    resetButtons();
                    stopPolling();
                }
            }
            
        } catch (error) {
            console.error('Failed to update progress:', error);
        }
    }
    
    function updateProgressBar(progress) {
        const progressBar = document.getElementById('optimizationProgress');
        const progressText = document.getElementById('progressText');
        const statusText = document.getElementById('optimizationStatus');
        
        const percentage = Math.round((progress.current_generation / progress.total_generations) * 100);
        
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressText.textContent = `${percentage}%`;
        statusText.textContent = `Generation: ${progress.current_generation} / ${progress.total_generations}`;
    }
    
    function updateCharts(chartData) {
        console.log('Updating charts with data:', chartData);
        
        // 1. Update Objective Evolution Chart - Multiple objectives as separate lines
        if (chartData.objective_evolution && charts.objective) {
            console.log('Updating objective evolution with:', chartData.objective_evolution);
            
            // Colors for different objectives
            const objectiveColors = {
                'MaximizeProfit': '#28a745',
                'MinimizeLoss': '#dc3545',
                'MaximizeNetPnL': '#007bff',
                'MaximizeWinRate': '#ffc107',
                'MinimizeDrawdown': '#6f42c1'
            };
            
            // Clear existing series
            while(charts.objective.series.length > 0) {
                charts.objective.series[0].remove(false);
            }
            
            // Add series for each objective
            Object.keys(chartData.objective_evolution).forEach((objectiveName, index) => {
                const data = chartData.objective_evolution[objectiveName];
                const color = objectiveColors[objectiveName] || Highcharts.getOptions().colors[index];
                
                charts.objective.addSeries({
                    name: objectiveName,
                    data: data,
                    color: color,
                    lineWidth: 2
                }, false);
            });
            
            charts.objective.redraw();
        }
        
        // 2. Update Parallel Coordinates Chart (like old app)
        if (chartData.elite_population_data && chartData.objective_names && charts.parallelCoords) {
            console.log('Updating parallel coordinates with:', chartData.elite_population_data);
            
            const eliteData = chartData.elite_population_data;
            const objectiveNames = chartData.objective_names;
            
            if (eliteData.length > 0 && objectiveNames.length > 0) {
                // Destroy and recreate chart with proper configuration (like old app)
                if (charts.parallelCoords) {
                    charts.parallelCoords.destroy();
                }
                
                const colors = Highcharts.getOptions().colors;
                const colorCount = colors.length;

                const chartConfig = {
                    chart: {
                        type: 'line',
                        parallelCoordinates: true,
                        parallelAxes: {
                            lineWidth: 2,
                            gridlinesWidth: 1,
                            title: {
                                style: { fontWeight: 'bold', fontSize: '12px' }
                            }
                        }
                    },
                    title: {
                        text: `Elite Population Analysis (${eliteData.length} Individuals)`,
                        style: { fontSize: '14px', fontWeight: 'bold' }
                    },
                    plotOptions: {
                        series: {
                            animation: { duration: 500 },
                            lineWidth: 2.5,
                            opacity: 0.75,
                            states: {
                                hover: { lineWidth: 4, opacity: 1 }
                            },
                            marker: {
                                enabled: false,
                                states: {
                                    hover: { enabled: true, radius: 4 }
                                }
                            }
                        }
                    },
                    tooltip: {
                        formatter: function() {
                            let tooltipText = '<b>Elite Individual #' + (this.series.index + 1) + '</b><br/>';
                            const individualData = eliteData[this.series.index];
                            objectiveNames.forEach(function(objName, i) {
                                tooltipText += objName + ': ' + Highcharts.numberFormat(individualData[i], 4) + '<br/>';
                            });
                            return tooltipText;
                        }
                    },
                    legend: { enabled: false },
                    credits: { enabled: false },
                    xAxis: objectiveNames.map((objName, index) => ({
                        lineWidth: 0,
                        labels: { enabled: false },
                        title: {
                            text: objName,
                            style: { fontWeight: 'bold', fontSize: '11px' }
                        }
                    })),
                    yAxis: objectiveNames.map((objName, index) => {
                        const values = eliteData.map(elite => elite[index]);
                        const min = Math.min(...values);
                        const max = Math.max(...values);
                        const padding = (max - min) * 0.1;

                        return {
                            lineWidth: 1,
                            min: min - padding,
                            max: max + padding,
                            title: { text: '', style: { fontSize: '10px' } },
                            labels: {
                                format: '{value:.3f}',
                                style: { fontSize: '9px' }
                            }
                        };
                    }),
                    series: eliteData.map((elite, index) => ({
                        name: `Elite ${index + 1}`,
                        data: elite.map((value, objIndex) => [objIndex, value]),
                        color: colors[index % colorCount],
                        lineWidth: index === 0 ? 3 : 2.5,
                        opacity: index === 0 ? 0.9 : 0.75
                    }))
                };

                charts.parallelCoords = Highcharts.chart('parallelCoordsChart', chartConfig);
            }
        }
        
        // 3. Update Winning Trades Distribution Chart
        if (chartData.winning_trades_distribution && charts.winningTrades) {
            const categories = chartData.winning_trades_distribution.map(item => item[0]);
            const data = chartData.winning_trades_distribution.map(item => item[1]);
            
            charts.winningTrades.update({
                xAxis: { categories: categories }
            }, false);
            charts.winningTrades.series[0].setData(data, true);
        }
        
        // 4. Update Losing Trades Distribution Chart  
        if (chartData.losing_trades_distribution && charts.losingTrades) {
            const categories = chartData.losing_trades_distribution.map(item => item[0]);
            const data = chartData.losing_trades_distribution.map(item => item[1]);
            
            charts.losingTrades.update({
                xAxis: { categories: categories }
            }, false);
            charts.losingTrades.series[0].setData(data, true);
        }
        
        // 4. Update Best Strategy Chart
        if (chartData.best_strategy && charts.bestStrategy) {
            // Update with candlestick data and trade triggers
            const candlestickData = chartData.best_strategy.candlestick_data || [];
            const triggers = chartData.best_strategy.triggers || [];
            
            charts.bestStrategy.series[0].setData(candlestickData, false);
            
            // Add buy/sell signals if they exist
            const buySignals = triggers.filter(t => t.type === 'buy').map(t => [t.timestamp, t.price]);
            const sellSignals = triggers.filter(t => t.type === 'sell').map(t => [t.timestamp, t.price]);
            
            // Add or update signal series
            if (charts.bestStrategy.series[1]) {
                charts.bestStrategy.series[1].setData(buySignals, false);
            } else {
                charts.bestStrategy.addSeries({
                    name: 'Buy Signals',
                    type: 'scatter',
                    data: buySignals,
                    color: '#28a745',
                    marker: { symbol: 'triangle', radius: 6 }
                }, false);
            }
            
            if (charts.bestStrategy.series[2]) {
                charts.bestStrategy.series[2].setData(sellSignals, false);
            } else {
                charts.bestStrategy.addSeries({
                    name: 'Sell Signals',
                    type: 'scatter',
                    data: sellSignals,
                    color: '#dc3545',
                    marker: { symbol: 'triangle-down', radius: 6 }
                }, false);
            }
            
            charts.bestStrategy.redraw();
        }
        
        // 5. Update Performance Metrics Table
        if (chartData.performance_metrics) {
            updatePerformanceMetricsTable(chartData.performance_metrics);
        }
    }
    
    function updatePerformanceMetricsTable(metricsData) {
        const tableBody = document.getElementById('metricsTable');
        
        if (!metricsData || metricsData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No performance data yet</td></tr>';
            return;
        }
        
        const rows = metricsData.map(metric => {
            const pnlClass = metric.total_pnl >= 0 ? 'text-success' : 'text-danger';
            
            return `
                <tr>
                    <td><strong>${metric.generation}</strong></td>
                    <td>${metric.total_trades}</td>
                    <td class="text-success">${metric.winning_trades}</td>
                    <td class="text-danger">${metric.losing_trades}</td>
                    <td class="${pnlClass}">${metric.total_pnl.toFixed(2)}%</td>
                    <td class="text-success">${metric.avg_win.toFixed(2)}%</td>
                    <td class="text-danger">${metric.avg_loss.toFixed(2)}%</td>
                </tr>
            `;
        }).join('');
        
        tableBody.innerHTML = rows;
    }
    
    // Elite functions removed since Elite Solutions table was removed
        
        if (!elites || elites.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No elite solutions yet</td></tr>';
            return;
        }
        
        const rows = elites.map((elite, index) => {
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${elite.fitness.toFixed(4)}</td>
                    <td>${elite.total_trades || 0}</td>
                    <td>${(elite.win_rate * 100).toFixed(1)}%</td>
                    <td class="${elite.total_pnl >= 0 ? 'text-success' : 'text-danger'}">${elite.total_pnl.toFixed(2)}%</td>
                    <td class="text-danger">${elite.max_drawdown.toFixed(2)}%</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewElite(${index})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="exportElite(${index})">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        tableBody.innerHTML = rows;
    }
    
    // Global functions for elite actions
    window.viewElite = async function(index) {
        try {
            const response = await fetch(`/optimizer/api/get_elite/${index}`);
            const result = await response.json();
            
            if (result.success) {
                // Open elite in replay visualization
                window.open(`/replay?elite=${encodeURIComponent(JSON.stringify(result.elite))}`, '_blank');
            } else {
                showAlert('Failed to load elite solution', 'danger');
            }
        } catch (error) {
            showAlert(`Failed to view elite: ${error.message}`, 'danger');
        }
    };
    
    window.exportElite = async function(index) {
        try {
            const response = await fetch(`/optimizer/api/export_elite/${index}`);
            const result = await response.json();
            
            if (result.success) {
                // Trigger download
                const blob = new Blob([JSON.stringify(result.config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `elite_${index + 1}_config.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                showAlert('Elite configuration exported successfully', 'success');
            } else {
                showAlert('Failed to export elite solution', 'danger');
            }
        } catch (error) {
            showAlert(`Failed to export elite: ${error.message}`, 'danger');
        }
    };
});
</script>
{% endblock %}