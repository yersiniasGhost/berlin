{% extends 'base.html' %}

{% block title %}Stock Analysis Dashboard{% endblock %}

{% block head_extra %}
<style>
    .ticker-card {
        transition: all 0.3s ease;
    }
    .ticker-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .progress-bull {
        background-color: #28a745;
    }
    .progress-bear {
        background-color: #dc3545;
    }
    .ticker-price {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .ticker-change-up {
        color: #28a745;
    }
    .ticker-change-down {
        color: #dc3545;
    }
    .empty-dashboard {
        min-height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>Market Dashboard</h2>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSymbolModal">
            <i class="fas fa-plus me-1"></i> Add Symbol
        </button>
        <!-- Add this somewhere on your dashboard, perhaps below the "Add Symbol" button -->
        <button id="testCardBtn" class="btn btn-outline-secondary">
            <i class="fas fa-vial me-1"></i> Test Card Display
        </button>
    </div>
</div>

<div id="tickerContainer" class="row g-4">
    <div class="col-12 empty-dashboard">
        <div class="text-center">
            <i class="fas fa-chart-line fa-5x mb-3 text-muted"></i>
            <h3>No ticker data available</h3>
            <p class="text-muted">Add symbols and start streaming to see data</p>
            <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#configModal">
                <i class="fas fa-cog me-1"></i> Configure
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    let activeCombinations = {};

        // Add this at the top of your script section
    socket.onAny((event, ...args) => {
      console.log(`SOCKET EVENT: ${event}`, args);
    });

    let tickerData = {};

    socket.on('ticker_update', function(data) {
        console.log('TICKER UPDATE RECEIVED:', data);

        // Get combination ID (fall back to symbol if combination_id not provided)
        const combinationId = data.combination_id || data.symbol;

        // Initialize data structure if needed
        if (!activeCombinations[combinationId]) {
            activeCombinations[combinationId] = {
                symbol: data.symbol,
                indicators: {},
                overall_scores: { bull: 0, bear: 0 },
                timestamp: null
            };
        }

        // Store indicator data
        activeCombinations[combinationId].indicators = data.indicators;
        activeCombinations[combinationId].overall_scores = data.overall_scores;

        // Update UI
        updateTickerUI();
    });

    socket.on('ticker_update', function(data) {
        // Get combination ID (fall back to symbol if combination_id not provided)
        const combinationId = data.combination_id || data.symbol;

        // Initialize data structure if needed
        if (!activeCombinations[combinationId]) {
            activeCombinations[combinationId] = {
                symbol: data.symbol,
                indicators: {},
                overall_scores: { bull: 0, bear: 0 },
                timestamp: null
            };
        }

        // Store the ticker data
        if (data.data) {
            Object.assign(activeCombinations[combinationId], data.data);
        } else {
            // Handle direct properties
            const props = ['open', 'high', 'low', 'close', 'volume', 'timestamp'];
            props.forEach(prop => {
                if (data[prop] !== undefined) {
                    activeCombinations[combinationId][prop] = data[prop];
                }
            });
        }

        // Update UI
        updateTickerUI();

    socket.on('candle_completed', function(data) {
        console.log('CANDLE COMPLETED:', data);

        if (!data || !data.symbol) {
            console.error('Invalid candle data:', data);
            return;
        }

        // Initialize if needed
        if (!tickerData[data.symbol]) {
            tickerData[data.symbol] = {};
        }

        // Store candle data
        if (data.candle) {
            Object.assign(tickerData[data.symbol], data.candle);
        }

        console.log('Ticker data after candle update:', tickerData[data.symbol]);

        // Update the UI
        updateTickerUI();
    });

    // Helper function to render indicators summary
    function renderIndicatorsSummary(symbol) {
        if (!tickerData[symbol] || !tickerData[symbol].indicators) {
            return '';
        }

        const indicators = tickerData[symbol].indicators;
        let html = '<div class="mt-2 small">';

        // Only show up to 3 top indicators in the card
        const indicatorNames = Object.keys(indicators);
        const topIndicators = indicatorNames.slice(0, 3);

        for (const name of topIndicators) {
            const value = indicators[name];

            // Skip if not a numeric value
            if (typeof value !== 'number') continue;

            // Format with color based on value
            let valueClass = 'text-muted';
            if (value > 0.7) {
                valueClass = name.toLowerCase().includes('bear') ? 'text-danger' : 'text-success';
            } else if (value > 0.3) {
                valueClass = name.toLowerCase().includes('bear') ? 'text-warning' : 'text-primary';
            }

            const displayName = name
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase());

            html += `
                <div class="d-flex justify-content-between mb-1">
                    <span>${displayName}:</span>
                    <span class="${valueClass} fw-bold">${value.toFixed(2)}</span>
                </div>
            `;
        }

        html += '</div>';
        return html;
    }

    // Modify updateTickerUI to handle multiple combinations
    function updateTickerUI() {
        const container = document.getElementById('tickerContainer');

        // Clear empty dashboard if we have data
        if (Object.keys(activeCombinations).length > 0) {
            const emptyDashboard = container.querySelector('.empty-dashboard');
            if (emptyDashboard) {
                container.innerHTML = '';
            }
        }

        // Process each combination
        for (const [combinationId, data] of Object.entries(activeCombinations)) {
            // Check if we already have a card for this combination
            let card = container.querySelector(`[data-combination-id="${combinationId}"]`);

            if (!card) {
                // Create new card
                const col = document.createElement('div');
                col.className = 'col-md-4 col-lg-3';

                card = document.createElement('div');
                card.className = 'card ticker-card shadow-sm';
                card.setAttribute('data-combination-id', combinationId);
                card.setAttribute('data-symbol', data.symbol);

                // Make card clickable to go to details page
                card.style.cursor = 'pointer';
                card.addEventListener('click', function() {
                    window.location.href = `/ticker/${data.symbol}?combination=${combinationId}`;
                });

                col.appendChild(card);
                container.appendChild(col);
            }

            // Now update the card content
            updateCardContent(card, data, combinationId);
        }
    }

    // New function to update card content
    function updateCardContent(card, data, combinationId) {
        // Get price change direction
        let changeDirection = '';
        let changeClass = '';
        if (data.previousClose && data.close > data.previousClose) {
            changeDirection = '▲';
            changeClass = 'ticker-change-up';
        } else if (data.previousClose && data.close < data.previousClose) {
            changeDirection = '▼';
            changeClass = 'ticker-change-down';
        }

        // Format price
        const price = typeof data.close === 'number' ? data.close.toFixed(2) : data.close;

        // Format timestamp
        let timeStr = '';
        if (data.timestamp) {
            const time = new Date(data.timestamp);
            timeStr = time.toLocaleTimeString();
        }

        // Get scores
        const bullScore = data.overall_scores?.bull || 0;
        const bearScore = data.overall_scores?.bear || 0;

        // Short name for the combination to display with symbol
        const configName = combinationId.split('-')[1] || '';

        // Update card content
        card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <h5 class="mb-0">${data.symbol}</h5>
                <small class="text-muted">${configName}</small>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="ticker-price ${changeClass}">${price} ${changeDirection}</span>
                    <span class="badge bg-secondary">${data.volume ? data.volume.toLocaleString() : 'N/A'}</span>
                </div>

                <div class="mb-3">
                    <label class="d-flex justify-content-between">
                        <span>Bullish Signal</span>
                        <span>${(bullScore * 100).toFixed(0)}%</span>
                    </label>
                    <div class="progress" style="height: 15px;">
                        <div class="progress-bar progress-bull" role="progressbar"
                             style="width: ${bullScore * 100}%"
                             aria-valuenow="${bullScore * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="d-flex justify-content-between">
                        <span>Bearish Signal</span>
                        <span>${(bearScore * 100).toFixed(0)}%</span>
                    </label>
                    <div class="progress" style="height: 15px;">
                        <div class="progress-bar progress-bear" role="progressbar"
                             style="width: ${bearScore * 100}%"
                             aria-valuenow="${bearScore * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                ${data.indicators ? renderIndicatorsSummary(data) : ''}
            </div>
            <div class="card-footer bg-white">
                <div class="d-flex justify-content-between">
                    <span class="small text-muted">Updated: ${timeStr}</span>
                    <span class="small text-muted">${configName}</span>
                </div>
            </div>
        `;
    }

    function renderIndicatorsSummary(data) {
        if (!data.indicators || Object.keys(data.indicators).length === 0) {
            return '';
        }

        const indicators = data.indicators;
        let html = '<div class="mt-2 small">';

        // Only show up to 3 top indicators in the card
        const indicatorNames = Object.keys(indicators);
        const topIndicators = indicatorNames.slice(0, 3);

        for (const name of topIndicators) {
            const value = indicators[name];

            // Skip if not a numeric value
            if (typeof value !== 'number') continue;

            // Format with color based on value
            let valueClass = 'text-muted';
            if (value > 0.7) {
                valueClass = name.toLowerCase().includes('bear') ? 'text-danger' : 'text-success';
            } else if (value > 0.3) {
                valueClass = name.toLowerCase().includes('bear') ? 'text-warning' : 'text-primary';
            }

            const displayName = name
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase());

            html += `
                <div class="d-flex justify-content-between mb-1">
                    <span>${displayName}:</span>
                    <span class="${valueClass} fw-bold">${value.toFixed(2)}</span>
                </div>
            `;
        }

        html += '</div>';
        return html;
    }

    // Check if we have data already
    function loadInitialData() {
        console.log('Loading initial ticker data...');
        fetch('/api/tickers')
            .then(response => response.json())
            .then(data => {
                console.log('Received initial data:', data);
                if (data && data.data) {
                    tickerData = data.data;
                    updateTickerUI();
                }
            })
            .catch(error => {
                console.error('Error loading ticker data:', error);
            });
    }

    function checkSocketConnection() {
        console.log('Checking Socket.IO connection');
        if (socket.connected) {
            console.log('Socket.IO connected');
        } else {
            console.log('Socket.IO not connected, trying to connect...');
            socket.connect();
        }

        // Try to load initial data
        loadInitialData();
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking Socket.IO connection...');
        checkSocketConnection();

        // Add symbol from modal
        document.getElementById('confirmAddSymbolBtn').addEventListener('click', function() {
            const symbolInput = document.getElementById('newSymbolInput');
            const symbol = symbolInput.value.trim().toUpperCase();

            if (symbol) {
                // Add to UI
                addSymbolToUI(symbol);

                // Clear input and close modal
                symbolInput.value = '';
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSymbolModal'));
                modal.hide();
            }
        });

        // Add the test card button handler here
        document.getElementById('testCardBtn').addEventListener('click', function() {
            // Create test data for PLTR
            const testData = {
                PLTR: {
                    symbol: 'PLTR',
                    timestamp: new Date().toISOString(),
                    open: 95.21,
                    high: 96.30,
                    low: 94.80,
                    close: 95.50,
                    volume: 1234567,
                    indicators: {
                        'macd_cross_bull': 0.3,
                        'bollinger_bull': 0.1,
                        'smaX_bull': 0.8,
                        'bollinger_bear': 0.2
                    },
                    overall_scores: {
                        bull: 0.4,
                        bear: 0.1
                    }
                }
            };

            // Directly set ticker data and update UI
            console.log('Setting test data:', testData);
            tickerData = testData;
            updateTickerUI();
        });
    });
</script>
{% endblock %}