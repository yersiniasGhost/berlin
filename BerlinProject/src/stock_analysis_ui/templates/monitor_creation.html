<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Creation - Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1419;
            color: #e6edf3;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Layout with sidebar */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: #161b22;
            border-right: 1px solid #30363d;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #30363d;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: #7d8590;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: #e6edf3;
            text-decoration: none;
            border-radius: 0 6px 6px 0;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            background: #21262d;
            color: #58a6ff;
        }

        .nav-link.active {
            background: #1f2937;
            color: #58a6ff;
            border-right: 3px solid #58a6ff;
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #58a6ff;
        }

        .nav-icon {
            font-size: 1.125rem;
            width: 20px;
            text-align: center;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            margin-left: 250px;
            min-height: 100vh;
        }

        .header {
            background: #161b22;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #30363d;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: #7d8590;
        }

        /* Form Container */
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .form-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e6edf3;
            font-weight: 500;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: #7d8590;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        /* Indicator Cards */
        .indicator-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .indicator-name {
            font-weight: 600;
            color: #f0f6fc;
            font-size: 1rem;
        }

        .remove-btn {
            background: #da3633;
            color: #ffffff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s ease;
        }

        .remove-btn:hover {
            background: #ff7b72;
        }

        /* Bar Cards */
        .bar-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .bar-card.bull {
            border-left: 4px solid #56d364;
        }

        .bar-card.bear {
            border-left: 4px solid #ff7b72;
        }

        .bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bar-name {
            font-weight: 600;
            color: #f0f6fc;
            font-size: 1rem;
        }

        .bar-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .bar-type.bull {
            background: rgba(86, 211, 100, 0.2);
            color: #56d364;
        }

        .bar-type.bear {
            background: rgba(255, 123, 114, 0.2);
            color: #ff7b72;
        }

        .weight-input {
            width: 80px;
            padding: 0.5rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #e6edf3;
            font-size: 0.875rem;
            text-align: center;
        }

        .threshold-input {
            width: 100px;
            padding: 0.5rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #e6edf3;
            font-size: 0.875rem;
            text-align: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #238636;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-secondary {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
        }

        .btn-secondary:hover {
            background: #30363d;
        }

        .btn-outline {
            background: transparent;
            color: #58a6ff;
            border: 1px solid #58a6ff;
        }

        .btn-outline:hover {
            background: #58a6ff;
            color: #0d1117;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .add-btn {
            background: #238636;
            color: #ffffff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s ease;
            margin-bottom: 1rem;
        }

        .add-btn:hover {
            background: #2ea043;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid;
        }

        .message.success {
            background: rgba(35, 134, 54, 0.1);
            border-color: #56d364;
            color: #56d364;
        }

        .message.error {
            background: rgba(218, 54, 51, 0.1);
            border-color: #ff7b72;
            color: #ff7b72;
        }

        .json-preview {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #e6edf3;
        }

        .indicator-weight {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-top: 1px solid #30363d;
        }

        .indicator-weight:first-child {
            border-top: none;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: block;
                background: none;
                border: none;
                color: #e6edf3;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
                margin-right: 1rem;
            }

            .form-container {
                padding: 0 1rem;
            }

            .form-row,
            .form-row-3,
            .form-row-4 {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Trading Dashboard</div>
                <div class="sidebar-subtitle">Navigation</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <span class="nav-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/monitor-creation" class="nav-link active">
                        <span class="nav-icon"></span>
                        <span>Monitor Creation</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>
                <h1>Monitor Creation</h1>
                <div class="header-subtitle">Create and configure your trading monitor</div>
            </div>

            <div class="form-container">
                <div id="messages"></div>

                <!-- Basic Information -->
                <div class="form-section">
                    <h2 class="section-title">Basic Information</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="monitorName">Monitor Name</label>
                            <input type="text" id="monitorName" class="form-input" placeholder="My Trading Monitor">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="testName">Test Name</label>
                            <input type="text" id="testName" class="form-input" placeholder="my-test-monitor">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Description</label>
                        <textarea id="description" class="form-textarea" placeholder="Describe your trading strategy..."></textarea>
                    </div>
                </div>

                <!-- Indicators Configuration -->
                <div class="form-section">
                    <h2 class="section-title">Indicators</h2>
                    <p style="color: #7d8590; margin-bottom: 1rem;">Configure the indicators for your trading strategy</p>

                    <button class="add-btn" onclick="addIndicator()">+ Add Indicator</button>

                    <div id="indicatorsList">
                        <!-- Indicators will be added here -->
                    </div>
                </div>

                <!-- Bars Configuration -->
                <div class="form-section">
                    <h2 class="section-title">Bars (Signal Combinations)</h2>
                    <p style="color: #7d8590; margin-bottom: 1rem;">Create both bear and bull bars before generating</p>

                    <div class="form-row">
                        <div>
                            <h3 style="color: #56d364; margin-bottom: 0.5rem;">Bull Bars (Long Entry)</h3>
                            <button class="add-btn" onclick="addBar('bull')">+ Add Bull Bar</button>
                            <div id="bullBars">
                                <!-- Bull bars will be added here -->
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #ff7b72; margin-bottom: 0.5rem;">Bear Bars (Long Exit)</h3>
                            <button class="add-btn" onclick="addBar('bear')">+ Add Bear Bar</button>
                            <div id="bearBars">
                                <!-- Bear bars will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Rules -->
                <div class="form-section">
                    <h2 class="section-title">Trading Rules</h2>
                    <p style="color: #7d8590; margin-bottom: 1rem;">Set trigger thresholds for entry and exit conditions</p>

                    <div class="form-row">
                        <div>
                            <h3 style="color: #56d364; margin-bottom: 0.5rem;">Entry Conditions</h3>
                            <div id="entryRules">
                                <!-- Entry rules will be populated here -->
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #ff7b72; margin-bottom: 0.5rem;">Exit Conditions</h3>
                            <div id="exitRules">
                                <!-- Exit rules will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Configuration -->
                <div class="form-section">
                    <h2 class="section-title">Generate Configuration</h2>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateConfig()">Generate Configuration</button>
                        <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
                    </div>

                    <div id="configPreview" class="json-preview" style="display: none;">
                        <!-- Generated configuration will appear here -->
                    </div>

                    <div class="btn-group" id="downloadSection" style="display: none;">
                        <button class="btn btn-primary" onclick="downloadConfig()">📥 Download Configuration</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration state
        let config = {
            basicInfo: {},
            indicators: [],
            bars: { bull: {}, bear: {} },
            tradingRules: { entry: {}, exit: {} }
        };

        let generatedConfig = null;
        let indicatorCounter = 1;
        let barCounter = 1;

        // Available indicator functions
        const indicatorFunctions = {
            'sma_crossover': {
                name: 'SMA Crossover',
                parameters: [
                    { name: 'period', type: 'number', default: 20, min: 1, max: 200 },
                    { name: 'trend', type: 'select', options: ['bullish', 'bearish'], default: 'bullish' },
                    { name: 'crossover_value', type: 'number', default: 0.001, min: 0, max: 1, step: 0.0001 },
                    { name: 'lookback', type: 'number', default: 10, min: 1, max: 100 }
                ]
            },
            'macd_histogram_crossover': {
                name: 'MACD Histogram Crossover',
                parameters: [
                    { name: 'slow', type: 'number', default: 26, min: 1, max: 100 },
                    { name: 'fast', type: 'number', default: 12, min: 1, max: 100 },
                    { name: 'signal', type: 'number', default: 9, min: 1, max: 50 },
                    { name: 'histogram_threshold', type: 'number', default: 0.001, min: 0, max: 1, step: 0.0001 },
                    { name: 'lookback', type: 'number', default: 10, min: 1, max: 100 },
                    { name: 'trend', type: 'select', options: ['bullish', 'bearish'], default: 'bullish' }
                ]
            },
            'bol_bands_lower_band_bounce': {
                name: 'Bollinger Bands Lower Band Bounce',
                parameters: [
                    { name: 'period', type: 'number', default: 20, min: 1, max: 100 },
                    { name: 'sd', type: 'number', default: 2.0, min: 0.1, max: 5.0, step: 0.1 },
                    { name: 'candle_bounce_number', type: 'number', default: 1, min: 1, max: 10 },
                    { name: 'bounce_trigger', type: 'number', default: 0.05, min: 0, max: 1, step: 0.01 },
                    { name: 'lookback', type: 'number', default: 10, min: 1, max: 100 },
                    { name: 'trend', type: 'select', options: ['bullish', 'bearish'], default: 'bullish' }
                ]
            }
        };

        // Add new indicator
        function addIndicator() {
            const indicatorId = `indicator_${indicatorCounter++}`;
            const indicator = {
                id: indicatorId,
                name: `indicator_${indicatorCounter - 1}`,
                function: 'sma_crossover',
                aggConfig: '1m-normal',
                parameters: {}
            };

            // Set default parameters
            const funcData = indicatorFunctions[indicator.function];
            funcData.parameters.forEach(param => {
                indicator.parameters[param.name] = param.default;
            });

            config.indicators.push(indicator);
            renderIndicators();
        }

        // Render indicators
        function renderIndicators() {
            const container = document.getElementById('indicatorsList');
            container.innerHTML = '';

            config.indicators.forEach(indicator => {
                const div = document.createElement('div');
                div.className = 'indicator-card';
                div.innerHTML = `
                    <div class="indicator-header">
                        <div class="indicator-name">${indicator.name}</div>
                        <button class="remove-btn" onclick="removeIndicator('${indicator.id}')">Remove</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Indicator Name</label>
                            <input type="text" class="form-input" value="${indicator.name}"
                                   onchange="updateIndicator('${indicator.id}', 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Function</label>
                            <select class="form-select" onchange="updateIndicatorFunction('${indicator.id}', this.value)">
                                ${Object.entries(indicatorFunctions).map(([key, func]) =>
                                    `<option value="${key}" ${indicator.function === key ? 'selected' : ''}>${func.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Timeframe</label>
                            <select class="form-select" onchange="updateAggConfig('${indicator.id}', this.value, '${indicator.aggConfig.split('-')[1]}')">
                                <option value="1m" ${indicator.aggConfig.startsWith('1m') ? 'selected' : ''}>1 Minute</option>
                                <option value="5m" ${indicator.aggConfig.startsWith('5m') ? 'selected' : ''}>5 Minutes</option>
                                <option value="15m" ${indicator.aggConfig.startsWith('15m') ? 'selected' : ''}>15 Minutes</option>
                                <option value="30m" ${indicator.aggConfig.startsWith('30m') ? 'selected' : ''}>30 Minutes</option>
                                <option value="1h" ${indicator.aggConfig.startsWith('1h') ? 'selected' : ''}>1 Hour</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Candle Type</label>
                            <select class="form-select" onchange="updateAggConfig('${indicator.id}', '${indicator.aggConfig.split('-')[0]}', this.value)">
                                <option value="normal" ${indicator.aggConfig.endsWith('normal') ? 'selected' : ''}>Normal</option>
                                <option value="Heiken" ${indicator.aggConfig.endsWith('Heiken') ? 'selected' : ''}>Heiken Ashi</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row-3">
                        ${renderIndicatorParameters(indicator)}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Render indicator parameters
        function renderIndicatorParameters(indicator) {
            const funcData = indicatorFunctions[indicator.function];
            return funcData.parameters.map(param => {
                const value = indicator.parameters[param.name];
                if (param.type === 'number') {
                    return `
                        <div class="form-group">
                            <label class="form-label">${param.name.charAt(0).toUpperCase() + param.name.slice(1)}</label>
                            <input type="number" class="form-input" value="${value}"
                                   min="${param.min || ''}" max="${param.max || ''}" step="${param.step || 1}"
                                   onchange="updateIndicatorParam('${indicator.id}', '${param.name}', parseFloat(this.value))">
                        </div>
                    `;
                } else if (param.type === 'select') {
                    return `
                        <div class="form-group">
                            <label class="form-label">${param.name.charAt(0).toUpperCase() + param.name.slice(1)}</label>
                            <select class="form-select" onchange="updateIndicatorParam('${indicator.id}', '${param.name}', this.value)">
                                ${param.options.map(option =>
                                    `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                }
            }).join('');
        }

        // Update indicator
        function updateIndicator(id, field, value) {
            const indicator = config.indicators.find(ind => ind.id === id);
            if (indicator) {
                indicator[field] = value;
                if (field === 'name') {
                    renderIndicators();
                    renderBars();
                }
            }
        }

        // Update indicator function
        function updateIndicatorFunction(id, functionName) {
            const indicator = config.indicators.find(ind => ind.id === id);
            if (indicator) {
                indicator.function = functionName;
                // Reset parameters for new function
                const funcData = indicatorFunctions[functionName];
                indicator.parameters = {};
                funcData.parameters.forEach(param => {
                    indicator.parameters[param.name] = param.default;
                });
                renderIndicators();
            }
        }

        // Update aggregation config
        function updateAggConfig(id, timeframe, candleType) {
            const indicator = config.indicators.find(ind => ind.id === id);
            if (indicator) {
                indicator.aggConfig = `${timeframe}-${candleType}`;
            }
        }

        // Update indicator parameter
        function updateIndicatorParam(id, paramName, value) {
            const indicator = config.indicators.find(ind => ind.id === id);
            if (indicator) {
                indicator.parameters[paramName] = value;
            }
        }

        // Remove indicator
        function removeIndicator(id) {
            config.indicators = config.indicators.filter(ind => ind.id !== id);
            renderIndicators();
            renderBars();
        }

        // Add bar
        function addBar(type) {
            const barName = prompt(`Enter name for new ${type} bar:`);
            if (!barName) return;

            config.bars[type][barName] = {
                type: type,
                indicators: {}
            };
            renderBars();
        }

        // Render bars
        function renderBars() {
            renderBarType('bull');
            renderBarType('bear');
            renderTradingRules();
        }

        // Render bar type
        function renderBarType(type) {
            const container = document.getElementById(`${type}Bars`);
            container.innerHTML = '';

            Object.entries(config.bars[type]).forEach(([barName, barData]) => {
                const div = document.createElement('div');
                div.className = `bar-card ${type}`;
                div.innerHTML = `
                    <div class="bar-header">
                        <div class="bar-name">${barName}</div>
                        <span class="bar-type ${type}">${type.toUpperCase()}</span>
                        <button class="remove-btn" onclick="removeBar('${type}', '${barName}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Add Indicator</label>
                        <select class="form-select" onchange="addIndicatorToBar('${type}', '${barName}', this.value); this.value='';">
                            <option value="">Select indicator...</option>
                            ${getAvailableIndicators(type).map(ind =>
                                `<option value="${ind.id}">${ind.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        ${renderBarIndicators(barName, barData, type)}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Render bar indicators
        function renderBarIndicators(barName, barData, type) {
            let html = '';

            Object.entries(barData.indicators).forEach(([indicatorId, weight]) => {
                const indicator = config.indicators.find(ind => ind.id === indicatorId);
                const indicatorName = indicator ? indicator.name : 'Unknown';

                html += `
                    <div class="indicator-weight">
                        <span>${indicatorName}</span>
                        <div>
                            <input type="number" class="weight-input"
                                   value="${weight}"
                                   step="0.1"
                                   min="0"
                                   max="10"
                                   onchange="updateBarWeight('${type}', '${barName}', '${indicatorId}', parseFloat(this.value))">
                            <button class="remove-btn" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                    onclick="removeIndicatorFromBar('${type}', '${barName}', '${indicatorId}')">×</button>
                        </div>
                    </div>
                `;
            });

            return html || '<div style="color: #7d8590; text-align: center; padding: 1rem;">No indicators added</div>';
        }

        // Get available indicators for bar type
        function getAvailableIndicators(type) {
            return config.indicators.filter(ind => {
                const trend = ind.parameters.trend;
                if (type === 'bull') {
                    return trend === 'bullish';
                } else {
                    return trend === 'bearish';
                }
            });
        }

        // Add indicator to bar
        function addIndicatorToBar(type, barName, indicatorId) {
            if (!indicatorId) return;

            config.bars[type][barName].indicators[indicatorId] = 1.0;
            renderBars();
        }

        // Update bar weight
        function updateBarWeight(type, barName, indicatorId, weight) {
            config.bars[type][barName].indicators[indicatorId] = weight;
        }

        // Remove indicator from bar
        function removeIndicatorFromBar(type, barName, indicatorId) {
            delete config.bars[type][barName].indicators[indicatorId];
            renderBars();
        }

        // Remove bar
        function removeBar(type, barName) {
            delete config.bars[type][barName];
            renderBars();
        }

        // Render trading rules
        function renderTradingRules() {
            renderRuleType('entry', 'entryRules', config.bars.bull);
            renderRuleType('exit', 'exitRules', config.bars.bear);
        }

        // Render rule type
        function renderRuleType(ruleType, containerId, bars) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            Object.keys(bars).forEach(barName => {
                const currentThreshold = config.tradingRules[ruleType][barName] || 0.5;

                const div = document.createElement('div');
                div.className = 'rule-item';
                div.innerHTML = `
                    <span>${barName} >=</span>
                    <input type="number" class="threshold-input"
                           value="${currentThreshold}"
                           min="0"
                           max="1"
                           step="0.1"
                           onchange="updateThreshold('${ruleType}', '${barName}', parseFloat(this.value))">
                `;
                container.appendChild(div);
            });
        }

        // Update threshold
        function updateThreshold(ruleType, barName, threshold) {
            config.tradingRules[ruleType][barName] = threshold;
        }

        // Generate configuration
        function generateConfig() {
            // Save basic info
            config.basicInfo = {
                monitorName: document.getElementById('monitorName').value.trim(),
                testName: document.getElementById('testName').value.trim(),
                description: document.getElementById('description').value.trim()
            };

            // Validation
            if (!config.basicInfo.monitorName || !config.basicInfo.testName) {
                showMessage('Please fill in monitor name and test name', 'error');
                return;
            }

            if (config.indicators.length === 0) {
                showMessage('Please add at least one indicator', 'error');
                return;
            }

            const bullBars = Object.keys(config.bars.bull);
            const bearBars = Object.keys(config.bars.bear);

            if (bullBars.length === 0 || bearBars.length === 0) {
                showMessage('Please create at least one bull bar and one bear bar', 'error');
                return;
            }

            // Generate the configuration
            generatedConfig = {
                test_name: config.basicInfo.testName,
                monitor: {
                    _id: "generated_monitor_id",
                    user_id: "user_id",
                    name: config.basicInfo.monitorName,
                    description: config.basicInfo.description,
                    enter_long: [],
                    exit_long: [],
                    bars: {}
                },
                indicators: []
            };

            // Process entry conditions (bull bars)
            bullBars.forEach(barName => {
                const threshold = config.tradingRules.entry[barName] || 0.5;
                generatedConfig.monitor.enter_long.push({
                    name: barName,
                    threshold: threshold
                });
            });

            // Process exit conditions (bear bars)
            bearBars.forEach(barName => {
                const threshold = config.tradingRules.exit[barName] || 0.5;
                generatedConfig.monitor.exit_long.push({
                    name: barName,
                    threshold: threshold
                });
            });

            // Process bars
            ['bull', 'bear'].forEach(type => {
                Object.entries(config.bars[type]).forEach(([barName, barData]) => {
                    const barIndicators = {};

                    // Convert indicator IDs to names and weights
                    Object.entries(barData.indicators).forEach(([indicatorId, weight]) => {
                        const indicator = config.indicators.find(ind => ind.id === indicatorId);
                        if (indicator) {
                            barIndicators[indicator.name] = weight;
                        }
                    });

                    generatedConfig.monitor.bars[barName] = {
                        type: type,
                        indicators: barIndicators
                    };
                });
            });

            // Process indicators
            config.indicators.forEach(indicator => {
                generatedConfig.indicators.push({
                    name: indicator.name,
                    type: "Indicator",
                    function: indicator.function,
                    agg_config: indicator.aggConfig,
                    calc_on_pip: false,
                    parameters: indicator.parameters
                });
            });

            // Display preview
            document.getElementById('configPreview').style.display = 'block';
            document.getElementById('configPreview').textContent = JSON.stringify(generatedConfig, null, 2);
            document.getElementById('downloadSection').style.display = 'block';

            showMessage('Configuration generated successfully!', 'success');
        }

        // Download configuration
        function downloadConfig() {
            if (!generatedConfig) {
                showMessage('No configuration to download', 'error');
                return;
            }

            const jsonString = JSON.stringify(generatedConfig, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${generatedConfig.test_name}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('Configuration downloaded successfully!', 'success');
        }

        // Clear all
        function clearAll() {
            if (confirm('Are you sure you want to clear all configuration? This cannot be undone.')) {
                config = {
                    basicInfo: {},
                    indicators: [],
                    bars: { bull: {}, bear: {} },
                    tradingRules: { entry: {}, exit: {} }
                };
                generatedConfig = null;
                indicatorCounter = 1;
                barCounter = 1;

                // Clear form fields
                document.getElementById('monitorName').value = '';
                document.getElementById('testName').value = '';
                document.getElementById('description').value = '';

                // Clear displays
                document.getElementById('indicatorsList').innerHTML = '';
                document.getElementById('bullBars').innerHTML = '';
                document.getElementById('bearBars').innerHTML = '';
                document.getElementById('entryRules').innerHTML = '';
                document.getElementById('exitRules').innerHTML = '';
                document.getElementById('configPreview').style.display = 'none';
                document.getElementById('downloadSection').style.display = 'none';

                clearMessages();
            }
        }

        // Show message
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;

            setTimeout(() => {
                clearMessages();
            }, 5000);
        }

        // Clear messages
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Auto-generate test name from monitor name
        document.getElementById('monitorName').addEventListener('input', function() {
            const testName = this.value.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            document.getElementById('testName').value = testName;
        });

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(e.target) &&
                !toggle.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Initialize with empty state
        document.addEventListener('DOMContentLoaded', function() {
            // Start with no indicators or bars
            renderIndicators();
            renderBars();
        });
    </script>
</body>
</html>