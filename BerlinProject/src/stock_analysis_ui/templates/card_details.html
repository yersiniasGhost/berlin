<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Details - Trading Dashboard</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/highcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/modules/stock.min.js"></script>

    <!-- Shared CSS: Theme + Components -->
    <link rel="stylesheet" href="{{ url_for('shared.static', filename='css/themes/dark.css') }}">
    <link rel="stylesheet" href="{{ url_for('shared.static', filename='css/chart-components.css') }}">

    <!-- Shared JavaScript Modules -->
    <script src="{{ url_for('shared.static', filename='js/indicator-charts.js') }}"></script>
    <script src="{{ url_for('shared.static', filename='js/timezone-utils.js') }}"></script>
    <script src="{{ url_for('shared.static', filename='js/trade-history-table.js') }}"></script>
    <script src="{{ url_for('shared.static', filename='js/bar-scores-chart.js') }}"></script>
    <script src="{{ url_for('shared.static', filename='js/chart-dashboard.js') }}"></script>

    <!-- Page-specific styles (layout only - colors from theme) -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Layout with sidebar */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0 6px 6px 0;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--color-link);
        }

        .nav-link.active {
            background: var(--bg-tertiary);
            color: var(--color-link);
            border-right: 3px solid var(--color-link);
        }

        .nav-icon {
            font-size: 1.125rem;
            width: 20px;
            text-align: center;
        }

        /* Main content area */
        .main-content {
            margin-left: 250px;
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .mobile-menu-toggle {
            display: none;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem 2rem;
            margin: 2rem;
            box-shadow: var(--shadow-card);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .symbol-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .symbol-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .symbol-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .config-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-left: 2rem;
            border-left: 1px solid var(--border-primary);
        }

        .config-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .live-price {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }

        .price-change {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .price-timestamp {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .price-positive { color: var(--color-success); }
        .price-negative { color: var(--color-danger); }

        /* Content Area */
        .content {
            flex: 1;
            padding: 0 2rem 2rem;
        }

        /* Two-column layout for indicators/trades */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Indicators Section (Left Column) */
        .indicators-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .indicators-list,
        .bars-list {
            margin-bottom: 2rem;
        }

        .indicators-list:last-child,
        .bars-list:last-child {
            margin-bottom: 0;
        }

        .subsection-title {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .indicators-grid {
            display: grid;
            gap: 0.75rem;
        }

        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .indicator-item:hover {
            border-color: var(--border-primary);
            transform: translateY(-1px);
        }

        .indicator-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .indicator-value {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .indicator-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Bar items */
        .bar-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }

        .bar-item:last-child {
            margin-bottom: 0;
        }

        .bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .bar-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bar-score {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1rem;
        }

        .bar-calculation {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
        }

        /* Value color coding */
        .value-high { color: var(--color-success); }
        .value-medium { color: var(--color-warning); }
        .value-low { color: var(--color-danger); }

        /* Full-width chart sections */
        .full-width-section {
            grid-column: 1 / -1;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            background: var(--bg-tertiary);
            border-radius: 50%;
        }

        .empty-state-text {
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                left: -250px;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 200;
                background: var(--bg-primary);
                border: 1px solid var(--border-primary);
                color: var(--text-primary);
                padding: 0.5rem;
                border-radius: var(--radius-md);
                font-size: 1.25rem;
                cursor: pointer;
            }

            .two-column-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .config-section {
                padding-left: 0;
                border-left: none;
                border-top: 1px solid var(--border-primary);
                padding-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Trading Dashboard</div>
                <div class="sidebar-subtitle">Real-time Analysis</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <span class="nav-icon">ðŸ“Š</span>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link active">
                        <span class="nav-icon">ðŸ“ˆ</span>
                        <span>Card Details</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <button class="mobile-menu-toggle" onclick="toggleSidebar()">â˜°</button>

            <!-- Header Bar -->
            <div class="header-bar">
                <div class="header-content">
                    <div class="header-left">
                        <div class="symbol-section">
                            <div class="symbol-name" id="symbolName">LOADING...</div>
                            <div class="symbol-subtitle">Trading Signal Details</div>
                        </div>
                        <div class="config-section">
                            <div class="config-label">Configuration</div>
                            <div class="config-name" id="configName">Loading...</div>
                        </div>
                    </div>
                    <div class="price-section">
                        <div class="live-price" id="livePrice">N/A</div>
                        <div class="price-change" id="priceChange">--</div>
                        <div class="price-timestamp" id="priceTimestamp">Waiting for data...</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="content">
                <div class="two-column-layout">
                    <!-- Left Column: Live Indicators and Bar Calculations -->
                    <div class="indicators-section">
                        <div class="section-header">
                            <div>
                                <div class="section-title">Indicators & Calculations</div>
                                <div class="section-subtitle">Real-time technical analysis and bar scoring</div>
                            </div>
                        </div>

                        <!-- Individual Indicators (Live Values) -->
                        <div class="indicators-list">
                            <h4 class="subsection-title">Individual Indicators</h4>
                            <div id="indicatorsList" class="indicators-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-text">Loading indicator data...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bar Calculations (Live Values) -->
                        <div class="bars-list">
                            <h4 class="subsection-title">Composite Calculations</h4>
                            <div id="barsList">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-text">Loading bar calculations...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Trade History Table (Shared Component) -->
                    <div id="tradeHistorySection">
                        {% set table_id = "tradeHistoryTable" %}
                        {% set theme = "dark" %}
                        {% set show_cumulative = true %}
                        {% set show_signal = true %}
                        {% set show_details = true %}
                        {% include 'shared/components/_trade_history_table.html' %}
                    </div>

                    <!-- Candlestick Chart (Full Width) -->
                    <div class="full-width-section">
                        {% set container_id = "candlestickChart" %}
                        {% set section_id = "candlestickSection" %}
                        {% set title = "Price Chart" %}
                        {% set height = 500 %}
                        {% set theme = "dark" %}
                        {% include 'shared/components/_candlestick_chart.html' %}
                    </div>

                    <!-- Bar Scores Chart (Full Width - NEW) -->
                    <div class="full-width-section">
                        {% set container_id = "barScoresChart" %}
                        {% set section_id = "barScoresSection" %}
                        {% set title = "Bar Scores Analysis" %}
                        {% set height = 280 %}
                        {% set theme = "dark" %}
                        {% include 'shared/components/_bar_scores_chart.html' %}
                    </div>

                    <!-- Indicator Charts with Tabs (Full Width) -->
                    <div class="full-width-section">
                        {% set tabs_id = "indicatorTabs" %}
                        {% set contents_id = "indicatorTabContents" %}
                        {% set section_id = "indicatorChartsSection" %}
                        {% set chart_height = 400 %}
                        {% set theme = "dark" %}
                        {% include 'shared/components/_indicator_tabs.html' %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Trade Details Modal (Shared Component) -->
    {% set modal_id = "tradeDetailsModal" %}
    {% set theme = "dark" %}
    {% include 'shared/components/_trade_details_modal.html' %}

    <script>
        // ========================================
        // Card Details Page Controller
        // ========================================

        // Get card_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('card_id');

        // Global state
        let dashboard = null;
        let currentMonitorConfig = null;
        const socket = io();

        // ========================================
        // Initialization
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize timezone settings
            if (typeof initializeTimezone === 'function') {
                initializeTimezone();
            }

            // Initialize ChartDashboard orchestrator
            dashboard = new ChartDashboard({
                theme: 'dark',
                apiBaseUrl: '/api',
                containers: {
                    candlestick: 'candlestickChart',
                    barScores: 'barScoresChart',
                    indicatorTabs: 'indicatorTabs',
                    indicatorContents: 'indicatorTabContents',
                    tradeTable: 'tradeHistoryTable'
                }
            });

            // Load card details if card_id present
            if (cardId) {
                loadCardDetails(cardId);
            }
        });

        // ========================================
        // Data Loading
        // ========================================

        async function loadCardDetails(cardId) {
            try {
                console.log(`Loading card details for: ${cardId}`);

                // Fetch card details for header info
                const response = await fetch(`/api/combinations/${cardId}/details`);
                const data = await response.json();

                if (data.success) {
                    // Store monitor config
                    currentMonitorConfig = data.monitor_config;

                    // Update header info
                    updateHeaderInfo(data);

                    // Update live indicator values
                    if (data.current_values) {
                        updateIndicatorsSection(
                            data.current_values.indicators,
                            data.current_values.raw_indicators,
                            data.current_values.bar_scores
                        );
                    }

                    // Initialize dashboard with chart data
                    await dashboard.initialize(cardId);

                    // Update candlestick title with symbol
                    if (data.card_info?.symbol) {
                        updateCandlestickTitle(data.card_info.symbol, '1m');
                    }

                } else {
                    throw new Error(data.error || 'Failed to load card details');
                }

            } catch (error) {
                console.error('Error loading card details:', error);
                document.getElementById('configName').textContent = `Error: ${error.message}`;
            }
        }

        function updateHeaderInfo(data) {
            // Update symbol name
            if (data.card_info?.symbol) {
                document.getElementById('symbolName').textContent = data.card_info.symbol;
            } else {
                document.getElementById('symbolName').textContent = cardId;
            }

            // Update config name
            if (data.card_info?.config_name) {
                document.getElementById('configName').textContent = data.card_info.config_name;
            } else if (data.monitor_config?.name) {
                document.getElementById('configName').textContent = data.monitor_config.name;
            }
        }

        // ========================================
        // WebSocket Real-time Updates
        // ========================================

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('card_update', function(data) {
            if (data.card_id !== cardId) return;

            // Update header bar with live price
            updateLivePrice(data);

            // Update live indicator values
            updateIndicatorsSection(data.indicators, data.raw_indicators, data.bar_scores);

            // Update current candle on chart
            if (data.ohlc && data.timestamp && typeof updateCurrentCandle === 'function') {
                updateCurrentCandle(data.ohlc, data.timestamp);
            }
        });

        socket.on('candle_completed', function(data) {
            if (data.card_id !== cardId) return;

            // Add completed candle to chart
            if (data.completed_candle && typeof addCandleToChart === 'function') {
                addCandleToChart(data.completed_candle);
            }
        });

        // ========================================
        // UI Update Functions
        // ========================================

        function updateLivePrice(data) {
            const priceElement = document.getElementById('livePrice');
            if (priceElement && data.price !== undefined && data.price !== null) {
                priceElement.textContent = `$${data.price.toFixed(2)}`;
                priceElement.className = 'live-price ' + (data.price >= 0 ? 'price-positive' : 'price-negative');
            }

            const timestampElement = document.getElementById('priceTimestamp');
            if (timestampElement) {
                const now = new Date();
                const timeStr = typeof formatTimeInTimezone === 'function'
                    ? formatTimeInTimezone(now, window.currentTimezone)
                    : now.toLocaleTimeString();
                timestampElement.textContent = `Last updated: ${timeStr}`;
            }
        }

        function updateIndicatorsSection(indicators, rawIndicators, barScores) {
            updateIndicatorsList(indicators, rawIndicators);
            updateBarsList(barScores, indicators);
        }

        function updateIndicatorsList(indicators, rawIndicators) {
            const container = document.getElementById('indicatorsList');
            if (!indicators || Object.keys(indicators).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No indicator data available</div></div>';
                return;
            }

            let html = '';
            for (const [name, value] of Object.entries(indicators)) {
                if (value === undefined || value === null) continue;

                const displayName = name.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                const rawValue = rawIndicators?.[name];

                let valueClass = 'indicator-value';
                if (value > 0.7) valueClass += ' value-high';
                else if (value > 0.3) valueClass += ' value-medium';
                else valueClass += ' value-low';

                const detailsHtml = rawValue !== null && rawValue !== undefined
                    ? `<div class="indicator-details">Raw: ${typeof rawValue === 'number' ? rawValue.toFixed(4) : rawValue}</div>`
                    : '';

                html += `
                    <div class="indicator-item">
                        <div>
                            <div class="indicator-name">${displayName}</div>
                            ${detailsHtml}
                        </div>
                        <div class="${valueClass}">${value.toFixed(3)}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function updateBarsList(barScores, indicators) {
            const container = document.getElementById('barsList');
            if (!barScores || Object.keys(barScores).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No bar calculations available</div></div>';
                return;
            }

            let html = '';
            for (const [barName, score] of Object.entries(barScores)) {
                if (score === undefined || score === null) continue;

                const displayName = barName.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());

                let scoreClass = 'bar-score';
                if (score > 0.7) scoreClass += ' value-high';
                else if (score > 0.3) scoreClass += ' value-medium';
                else scoreClass += ' value-low';

                // Generate calculation breakdown if we have monitor config
                let calculationHtml = '';
                if (currentMonitorConfig?.bars?.[barName]) {
                    const calculation = calculateBarMath(barName, score, indicators);
                    calculationHtml = `<div class="bar-calculation">${calculation.math}</div>`;
                }

                html += `
                    <div class="bar-item">
                        <div class="bar-header">
                            <div class="bar-name">${displayName}</div>
                            <div class="${scoreClass}">${score.toFixed(3)}</div>
                        </div>
                        ${calculationHtml}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function calculateBarMath(barName, actualScore, indicators) {
            if (!currentMonitorConfig?.bars?.[barName]) {
                return { math: 'Calculation details not available' };
            }

            const barConfig = currentMonitorConfig.bars[barName];
            const weights = barConfig.indicators || {};

            let weightedSum = 0;
            let totalWeight = 0;
            const mathParts = [];

            Object.entries(weights).forEach(([indName, weight]) => {
                const indValue = indicators?.[indName] || 0;
                weightedSum += indValue * weight;
                totalWeight += weight;
                mathParts.push(`(${indValue.toFixed(3)} Ã— ${weight})`);
            });

            const calculatedScore = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
            const math = `${mathParts.join(' + ')} = ${weightedSum.toFixed(2)} Ã· ${totalWeight.toFixed(1)} = ${calculatedScore.toFixed(3)}`;

            return { math };
        }

        // ========================================
        // Event Handlers
        // ========================================

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Timeframe change handler for candlestick chart
        async function loadCandlestickData(timeframe) {
            if (!dashboard || !cardId) return;

            // Update button states
            document.querySelectorAll('[data-timeframe]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.timeframe === timeframe) {
                    btn.classList.add('active');
                }
            });

            // Reload data with new timeframe
            // Note: This would need API support for timeframe parameter
            console.log(`Timeframe changed to: ${timeframe}`);
            window.currentTimeframe = timeframe;

            // Update chart title
            const symbol = document.getElementById('symbolName').textContent;
            if (typeof updateCandlestickTitle === 'function') {
                updateCandlestickTitle(symbol, timeframe);
            }
        }

        // Timezone change handler
        function handleTimezoneChange(timezone) {
            // Call shared handler
            if (typeof onTimezoneChange === 'function') {
                onTimezoneChange(timezone);
            }

            // Redraw all charts
            if (dashboard) {
                Object.values(dashboard.getCharts()).forEach(chart => {
                    if (chart?.redraw) chart.redraw();
                });
            }

            // Re-render trade history with new timezone
            if (window.tradeHistoryTable && dashboard?.getData()?.trades) {
                window.tradeHistoryTable.render(
                    dashboard.getData().trades,
                    dashboard.getData().trade_details || {}
                );
            }
        }

        // Global chart zoom sync function (used by trade details)
        window.syncAllChartsFromDetails = function(min, max) {
            if (dashboard) {
                dashboard.syncAllChartsFromDetails(min, max);
            }
        };

        console.log('Card details page initialized');
    </script>
</body>
</html>
