<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Algorithm Optimizer - Dynamic Configuration</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- Highcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/highcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/modules/stock.min.js"></script>
    <!-- Parallel Coordinates module -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/modules/parallel-coordinates.min.js"></script>

    <!-- Shared form components -->
    <link rel="stylesheet" href="/static/css/config-form-builder.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/compact-monitor-form.css') }}">

    <style>
        .navbar-custom {
            padding: 20px 0;
            min-height: 80px;
        }

        .navbar-brand-custom {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .logo-img {
            height: 150px;
            width: auto;
            margin-right: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-ready { background: #d1ecf1; color: #0c5460; }
        .status-loading { background: #fff3cd; color: #856404; }
        .status-running { background: #d1ecf1; color: #0c5460; }
        .status-paused { background: #f0ad4e; color: #fff; }
        .status-error { background: #f8d7da; color: #721c24; }

        .configuration-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .configuration-header h5 {
            margin: 0;
            color: #495057;
        }


        .collapsible-section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .collapsible-header {
            background: #f8f9fa;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #dee2e6;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-content {
            padding: 10px;
            display: block;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        /* Compact configuration form */
        .config-actions {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .configuration-tabs {
            margin-bottom: 1rem;
        }

        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 0.75rem;
            background: #fff;
        }

        .action-buttons {
            margin: 0.5rem 0;
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        /* Make form elements more compact */
        .form-group {
            margin-bottom: 0.5rem;
        }

        .form-control {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .form-label {
            font-size: 0.825rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.775rem;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
        }

        .collapse-icon.rotated {
            transform: rotate(180deg);
        }



        .best-individuals-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .metrics-table {
            font-size: 0.8rem;
            margin: 0;
        }

        .metrics-table th,
        .metrics-table td {
            padding: 6px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .metrics-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-optimization {
            min-width: 100px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .navbar-brand-custom {
                font-size: 1.2rem;
            }
            
            .logo-img {
                height: 100px;
            }
            
            .metrics-table {
                font-size: 0.7rem;
            }
            
            .chart-container {
                height: 300px !important;
            }
        }

        @media (max-width: 576px) {
            .navbar-brand-custom {
                font-size: 1rem;
            }
            
            .logo-img {
                height: 80px;
                margin-right: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-sm {
                width: 100%;
                margin-bottom: 0.25rem;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn-optimization {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Enhanced chart styling */
        .chart-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: white;
        }

        /* Improved optimization progress styling */
        .optimization-progress {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-dark bg-dark mb-4 navbar-custom">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 navbar-brand-custom">
                    <img src="/static/mlf_logo.png" alt="Logo" class="logo-img">
                    Genetic Algorithm Optimizer - Dynamic Configuration
                </span>
                <span id="appStatus" class="status-badge status-ready">Ready</span>
            </div>
        </nav>

        <!-- Configuration Panel -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapse('configPanel')">
                <h3 class="mb-0"><i class="fas fa-cogs"></i> Configuration Setup</h3>
                <i class="fas fa-chevron-down collapse-icon" id="configPanel-icon"></i>
            </div>
            <div id="configPanel" class="collapsible-content">
                
                <!-- Configuration Actions -->
                <div class="config-actions">
                    <h5><i class="fas fa-file-upload"></i> Load Configuration Files</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="gaConfigFile" class="form-label">GA Configuration JSON</label>
                            <input type="file" class="form-control" id="gaConfigFile" accept=".json">
                        </div>
                        <div class="col-md-4">
                            <label for="dataConfigFile" class="form-label">Data Configuration JSON</label>
                            <input type="file" class="form-control" id="dataConfigFile" accept=".json">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button id="loadFilesBtn" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Load Files
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Configuration Tabs -->
                <div class="configuration-tabs">
                    <!-- Single Configuration Section -->
                    <div class="configuration-header">
                        <h5><i class="fas fa-robot"></i> GA Configuration</h5>
                    </div>
                    
                    <!-- Single Configuration Form -->
                    <div class="configuration-form">
                        <div id="compactGAFormContainer">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-upload fa-3x mb-3"></i>
                                <p>Load a GA configuration file to get started</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Status -->
                <div id="configStatus" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="configStatusMessage"></span>
                </div>

                <!-- Start Optimization Button -->
                <div class="text-center">
                    <button id="startOptimizationBtn" class="btn btn-success btn-lg" disabled>
                        <i class="fas fa-play"></i> Start Genetic Algorithm Optimization
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div id="controlPanel" class="collapsible-section" style="display: none;">
            <div class="collapsible-header" onclick="toggleCollapse('optimizationProgress')">
                <h3 class="mb-0"><i class="fas fa-chart-bar"></i> Optimization Progress</h3>
                <i class="fas fa-chevron-down collapse-icon" id="optimizationProgress-icon"></i>
            </div>
            <div id="optimizationProgress" class="collapsible-content" style="display: none;">
                <div class="progress-info">
                    <h5 id="testName">Test: Loading...</h5>
                    <span id="generationInfo">Generation 0 / 0</span>
                </div>
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="control-buttons">
                    <button id="pauseBtn" class="btn btn-warning btn-optimization" style="display: none;">
                        <i class="fas fa-pause me-2"></i>Pause
                    </button>
                    <button id="resumeBtn" class="btn btn-info btn-optimization" style="display: none;">
                        <i class="fas fa-play me-2"></i>Resume
                    </button>
                    <button id="stopBtn" class="btn btn-danger btn-optimization" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Stop
                    </button>
                    <button id="saveCurrentBtn" class="btn btn-success btn-optimization" style="display: none;">
                        <i class="fas fa-save me-2"></i>Save Current Best
                    </button>
                </div>

                <!-- Objectives Chart and Metrics Table -->
                <div class="row mb-3 mt-4">
                    <div class="col-md-6">
                        <h6>Optimization Progress - Objective Functions:</h6>
                        <div id="objectivesChart" style="height: 800px; border: 1px solid #dee2e6; border-radius: 4px; background: white;"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Generation Metrics Summary:</h6>
                        <div class="table-container">
                            <table class="table table-sm metrics-table">
                                <thead>
                                    <tr>
                                        <th>Gen</th>
                                        <th>Total Trades</th>
                                        <th>Winning</th>
                                        <th>Losing</th>
                                        <th>Total P&L (%)</th>
                                        <th>Avg Win (%)</th>
                                        <th>Avg Loss (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-muted">No data yet...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Best Individual Metrics:</h6>
                        <div id="currentMetrics" class="small text-muted">No data yet...</div>
                    </div>
                    <div class="col-md-6">
                        <h6>Best Individuals Log:</h6>
                        <div id="bestIndividualsLog" class="best-individuals-log" style="height: 200px;">
                            <div class="text-muted">Optimization not started...</div>
                        </div>
                    </div>
                </div>

                <!-- Parallel Coordinates Chart Section -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6><i class="fas fa-project-diagram me-2"></i>Elite Population - Parallel Coordinates Analysis</h6>
                        <div id="parallelCoordsChart" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
                            <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                                <i class="fas fa-chart-line me-2"></i>Waiting for elite population data...
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                This chart shows the objective function values for elite individuals. Each line represents one elite solution across all objectives.
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Trade Distribution Histograms Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h6><i class="fas fa-chart-bar me-2"></i>Trade Performance Distribution</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h7 class="text-success"><i class="fas fa-arrow-up me-1"></i>Winning Trades Distribution</h7>
                                <div id="winningTradesHistogram" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
                                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                                        <i class="fas fa-chart-bar me-2"></i>Waiting for trade data...
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h7 class="text-danger"><i class="fas fa-arrow-down me-1"></i>Losing Trades Distribution</h7>
                                <div id="losingTradesHistogram" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
                                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                                        <i class="fas fa-chart-bar me-2"></i>Waiting for trade data...
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Distribution shows the frequency of trades in different percentage gain/loss ranges. X-axis: Percentage ranges, Y-axis: Number of trades.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Shared form components -->
    <script src="/static/js/indicator-parameter-definitions.js"></script>
    <script src="/static/js/config-form-builder.js"></script>
    <script src="/static/js/data-config-form.js"></script>
    <script src="{{ url_for('static', filename='js/compact-monitor-form.js') }}"></script>

    <script>
        // Initialize Socket.IO
        const socket = io();

        // Global variables
        let uploadedFiles = {};
        let optimizationRunning = false;
        let charts = {};
        let parallelCoordsChart = null;
        let generationMetrics = [];
        let currentTestName = '';
        let currentTimestamp = '';

        // Form builders
        let compactGAForm = null;

        // Configuration data
        let currentGAConfig = null;
        let currentDataConfig = null;

        // Collapsible section toggle function
        function toggleCollapse(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');

            if (content.classList.contains('collapsed') || content.style.display === 'none') {
                content.classList.remove('collapsed');
                content.style.display = 'block';
                icon.classList.remove('rotated');
            } else {
                content.classList.add('collapsed');
                content.style.display = 'none';
                icon.classList.add('rotated');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // File upload handlers
            document.getElementById('gaConfigFile').addEventListener('change', handleFileUpload);
            document.getElementById('dataConfigFile').addEventListener('change', handleFileUpload);
            
            // Button handlers
            document.getElementById('loadFilesBtn').addEventListener('click', loadConfigurationFiles);
            document.getElementById('startOptimizationBtn').addEventListener('click', startOptimization);

            // Config action handlers - All config buttons are now handled by the compact form

            // Control button handlers
            document.getElementById('pauseBtn').addEventListener('click', () => socket.emit('pause_optimization'));
            document.getElementById('resumeBtn').addEventListener('click', () => socket.emit('resume_optimization'));
            document.getElementById('stopBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to stop the optimization?')) {
                    socket.emit('stop_optimization');
                }
            });

            document.getElementById('saveCurrentBtn').addEventListener('click', () => {
                if (confirm('Save the current best monitors and results?')) {
                    socket.emit('save_current_best');
                }
            });
        });

        // File upload handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileType = event.target.id === 'gaConfigFile' ? 'ga_config' : 'data_config';
            
            try {
                updateStatus('Uploading...', 'loading');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', fileType);

                const response = await fetch('/api/upload_file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    uploadedFiles[fileType] = result.filepath;
                    console.log(`${fileType} uploaded:`, result.filepath);
                    updateStatus('Ready', 'ready');
                    updateLoadButtonState();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                updateStatus('Error', 'error');
                alert(`Upload failed: ${error.message}`);
            }
        }

        // Load configuration files and generate forms
        async function loadConfigurationFiles() {
            if (!uploadedFiles.ga_config || !uploadedFiles.data_config) {
                alert('Please select both configuration files first.');
                return;
            }

            try {
                updateStatus('Loading configurations...', 'loading');

                const response = await fetch('/api/load_configs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ga_config_path: uploadedFiles.ga_config,
                        data_config_path: uploadedFiles.data_config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentGAConfig = result.ga_config;
                    currentDataConfig = result.data_config;
                    
                    generateForms();
                    updateStatus('Ready', 'ready');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Config loading error:', error);
                updateStatus('Error', 'error');
                alert(`Failed to load configurations: ${error.message}`);
            }
        }

        // Generate dynamic forms
        function generateForms() {
            // Use compact GA form (GA configs contain monitor config)
            compactGAForm = new CompactMonitorForm('compactGAFormContainer', {
                showDataConfig: true,
                showRanges: true,
                showGAHyperparameters: true
            });
            
            // Pass the full GA config to the form so it can access objectives and ga_hyperparameters
            let fullConfig = currentGAConfig;
            if (currentGAConfig && currentGAConfig.monitor) {
                // Ensure we have all parts in the right structure
                fullConfig = {
                    ...currentGAConfig,
                    monitor: currentGAConfig.monitor,
                    indicators: currentGAConfig.indicators || [],
                    objectives: currentGAConfig.objectives || [],
                    ga_hyperparameters: currentGAConfig.ga_hyperparameters || {}
                };
            }
            
            compactGAForm.generateForm(fullConfig, currentDataConfig);

            // Set up form change handlers
            setupFormChangeHandlers();
            
            // Enable action buttons
            enableActionButtons();

            console.log('Forms generated successfully');
        }

        // Set up form change handlers
        function setupFormChangeHandlers() {
            // Listen for configuration changes from compact GA form
            document.getElementById('compactGAFormContainer').addEventListener('monitorConfigSave', (event) => {
                const data = event.detail;
                if (data.monitorConfig) {
                    currentGAConfig = data.monitorConfig;
                    console.log('GA Config updated:', currentGAConfig);
                }
                if (data.dataConfig) {
                    const oldDataConfig = currentDataConfig;
                    currentDataConfig = data.dataConfig;
                    console.log('Data Config updated:', currentDataConfig);
                    
                    // Show confirmation message for data config changes
                    showConfigConfirmation(oldDataConfig, currentDataConfig);
                }
            });
        }
        
        // Show confirmation when data config changes
        function showConfigConfirmation(oldConfig, newConfig) {
            let changes = [];
            
            if (!oldConfig) {
                changes.push(`Using ticker: ${newConfig.ticker}`);
                changes.push(`Date range: ${newConfig.start_date} to ${newConfig.end_date}`);
            } else {
                if (oldConfig.ticker !== newConfig.ticker) {
                    changes.push(`Ticker changed from ${oldConfig.ticker} to ${newConfig.ticker}`);
                }
                if (oldConfig.start_date !== newConfig.start_date || oldConfig.end_date !== newConfig.end_date) {
                    changes.push(`Date range changed to ${newConfig.start_date} to ${newConfig.end_date}`);
                }
            }
            
            if (changes.length > 0) {
                const configStatus = document.getElementById('configStatus');
                const configStatusMessage = document.getElementById('configStatusMessage');
                
                configStatusMessage.innerHTML = `<strong>Data Configuration Updated:</strong><br>${changes.join('<br>')}`;
                configStatus.className = 'alert alert-success';
                configStatus.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    configStatus.style.display = 'none';
                }, 5000);
            }
        }

        // Enable action buttons
        function enableActionButtons() {
            document.getElementById('startOptimizationBtn').disabled = false;
        }

        // Update load button state
        function updateLoadButtonState() {
            const hasFiles = uploadedFiles.ga_config && uploadedFiles.data_config;
            document.getElementById('loadFilesBtn').disabled = !hasFiles;
        }

        // Save configuration
        async function saveConfiguration(configType) {
            const formData = compactGAForm ? compactGAForm.getFormData() : null;
            const configData = configType === 'ga_config' ? 
                (formData ? formData.monitorConfig : currentGAConfig) :
                (formData ? formData.dataConfig : currentDataConfig);

            if (!configData) {
                alert('No configuration data to save');
                return;
            }

            try {
                const response = await fetch('/api/save_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_data: configData,
                        config_type: configType,
                        filename: `${configData.test_name || configData.ticker || 'config'}.json`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert(`Failed to save configuration: ${error.message}`);
            }
        }

        // Download configuration
        async function downloadConfiguration(configType) {
            const formData = compactGAForm ? compactGAForm.getFormData() : null;
            const configData = configType === 'ga_config' ? 
                (formData ? formData.monitorConfig : currentGAConfig) :
                (formData ? formData.dataConfig : currentDataConfig);

            if (!configData) {
                alert('No configuration data to download');
                return;
            }

            try {
                const response = await fetch('/api/download_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_data: configData,
                        config_type: configType,
                        test_name: configData.test_name || configData.ticker || 'config'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = result.download_url;
                    link.download = result.filename;
                    link.click();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Download error:', error);
                alert(`Failed to prepare download: ${error.message}`);
            }
        }

        // Validate configuration
        async function validateConfiguration(configType) {
            const formData = compactGAForm ? compactGAForm.getFormData() : null;
            const configData = configType === 'ga_config' ? 
                (formData ? formData.monitorConfig : currentGAConfig) :
                (formData ? formData.dataConfig : currentDataConfig);

            if (!configData) {
                alert('No configuration data to validate');
                return;
            }

            try {
                const response = await fetch('/api/validate_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_data: configData,
                        config_type: configType
                    })
                });

                const result = await response.json();

                let message = result.message;
                if (result.warnings && result.warnings.length > 0) {
                    message += '\n\nWarnings:\n• ' + result.warnings.join('\n• ');
                }
                if (result.errors && result.errors.length > 0) {
                    message += '\n\nErrors:\n• ' + result.errors.join('\n• ');
                }

                alert(message);
            } catch (error) {
                console.error('Validation error:', error);
                alert(`Failed to validate configuration: ${error.message}`);
            }
        }

        // Start optimization
        async function startOptimization() {
            const formData = compactGAForm ? compactGAForm.getFormData() : null;
            const gaConfig = formData ? formData.monitorConfig : currentGAConfig;
            const dataConfig = formData ? formData.dataConfig : currentDataConfig;

            // Debug logging
            console.log('Starting optimization with:');
            console.log('GA Config:', gaConfig);
            console.log('Data Config:', dataConfig);
            if (dataConfig) {
                console.log(`Using ticker: ${dataConfig.ticker}, dates: ${dataConfig.start_date} to ${dataConfig.end_date}`);
            }

            if (!gaConfig || !dataConfig) {
                alert('Please configure both GA and data settings before starting optimization.');
                return;
            }

            try {
                updateStatus('Starting optimization...', 'loading');

                // Create temporary files for the current configurations
                const gaConfigBlob = new Blob([JSON.stringify(gaConfig, null, 2)], { type: 'application/json' });
                const dataConfigBlob = new Blob([JSON.stringify(dataConfig, null, 2)], { type: 'application/json' });

                const gaConfigFile = new File([gaConfigBlob], 'current_ga_config.json');
                const dataConfigFile = new File([dataConfigBlob], 'current_data_config.json');

                // Upload current configurations
                const gaFormData = new FormData();
                gaFormData.append('file', gaConfigFile);
                gaFormData.append('type', 'current_ga_config');

                const dataFormData = new FormData();
                dataFormData.append('file', dataConfigFile);
                dataFormData.append('type', 'current_data_config');

                const [gaUploadResponse, dataUploadResponse] = await Promise.all([
                    fetch('/api/upload_file', { method: 'POST', body: gaFormData }),
                    fetch('/api/upload_file', { method: 'POST', body: dataFormData })
                ]);

                const gaUploadResult = await gaUploadResponse.json();
                const dataUploadResult = await dataUploadResponse.json();

                if (!gaUploadResult.success || !dataUploadResult.success) {
                    throw new Error('Failed to upload configurations');
                }

                // Start optimization with uploaded file paths
                socket.emit('start_optimization', {
                    ga_config_path: gaUploadResult.filepath,
                    data_config_path: dataUploadResult.filepath
                });

                // Show control panel
                document.getElementById('controlPanel').style.display = 'block';

            } catch (error) {
                console.error('Start optimization error:', error);
                updateStatus('Error', 'error');
                alert(`Failed to start optimization: ${error.message}`);
            }
        }

        // Update status badge
        function updateStatus(text, type) {
            const statusElement = document.getElementById('appStatus');
            statusElement.textContent = text;
            statusElement.className = `status-badge status-${type}`;
        }

        // Socket event handlers (keeping existing ones)
        socket.on('connect', function() {
            console.log('Connected to server');
            updateStatus('Ready', 'ready');
        });

        socket.on('optimization_started', function(data) {
            console.log('🎯 Optimization started with data:', data);
            optimizationRunning = true;
            updateStatus('Running', 'running');

            currentTestName = data.test_name;
            const now = new Date();
            currentTimestamp = now.getFullYear() + '-' +
                              String(now.getMonth() + 1).padStart(2, '0') + '-' +
                              String(now.getDate()).padStart(2, '0') + '_' +
                              String(now.getHours()).padStart(2, '0') +
                              String(now.getMinutes()).padStart(2, '0') +
                              String(now.getSeconds()).padStart(2, '0');

            document.getElementById('testName').textContent = `Test: ${data.test_name}`;
            document.getElementById('generationInfo').textContent = `Generation 0 / ${data.total_generations}`;
            document.getElementById('optimizationProgress').style.display = 'block';

            generationMetrics = [];
            document.getElementById('metricsTableBody').innerHTML = '<tr><td colspan="7" class="text-muted">Starting optimization...</td></tr>';

            // Update button states
            document.getElementById('startOptimizationBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('saveCurrentBtn').style.display = 'none';

            document.getElementById('bestIndividualsLog').innerHTML = '<div class="text-muted">Starting optimization...</div>';
        });

        socket.on('generation_complete', function(data) {
            console.log('Generation complete:', data);

            // Update progress
            const progress = (data.generation / data.total_generations) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            document.getElementById('generationInfo').textContent = `Generation ${data.generation} / ${data.total_generations}`;

            // Update current metrics
            const metricsText = Object.entries(data.fitness_metrics)
                .map(([key, value]) => `${key}: ${value.toFixed(4)}`)
                .join(', ');
            document.getElementById('currentMetrics').textContent = metricsText;

            // Update best individuals log
            updateBestIndividualsLog(data.best_individuals_log);

            // Update objectives chart
            updateObjectivesChart(data.best_individuals_log);

            // Update parallel coordinates chart
            if (data.elite_objective_values && data.objective_names) {
                updateParallelCoordsChart(data.elite_objective_values, data.objective_names);
            }

            // Update metrics table
            updateMetricsTable(data.generation, data.chart_data);
        });

        socket.on('optimization_complete', function(data) {
            console.log('Optimization complete:', data);
            optimizationRunning = false;
            updateStatus('Complete - Results Saved!', 'ready');

            // Save generation metrics to CSV
            if (generationMetrics.length > 0) {
                saveGenerationMetrics();
            }

            // Show results information
            if (data.results_saved) {
                showResultsInfo(data.results_saved);
            } else if (data.save_error) {
                alert(`Results saved with warning: ${data.save_error}`);
            }

            // Update button states
            document.getElementById('startOptimizationBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('saveCurrentBtn').style.display = 'none';
        });

        socket.on('optimization_paused', function(data) {
            console.log('Optimization paused:', data);
            updateStatus(`Paused at Generation ${data.generation}`, 'paused');

            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'inline-block';
            document.getElementById('saveCurrentBtn').style.display = 'inline-block';
        });

        socket.on('optimization_resumed', function(data) {
            console.log('Optimization resumed:', data);
            updateStatus('Running', 'running');

            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('saveCurrentBtn').style.display = 'none';
        });

        socket.on('optimization_stopped', function(data) {
            console.log('Optimization stopped:', data);
            optimizationRunning = false;
            updateStatus('Stopped', 'ready');

            document.getElementById('startOptimizationBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('saveCurrentBtn').style.display = 'inline-block';
        });

        socket.on('optimization_error', function(data) {
            console.error('Optimization error:', data);
            optimizationRunning = false;
            updateStatus('Error', 'error');

            document.getElementById('startOptimizationBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';

            alert(`Optimization Error: ${data.error}`);
        });

        socket.on('save_current_success', function(data) {
            console.log('Save current best success:', data);
            alert(`✅ Successfully saved current best results at Generation ${data.generation}!\n\nFiles saved in: ${data.results_info?.results_dir || 'results directory'}`);
        });

        socket.on('save_current_error', function(data) {
            console.error('Save current best error:', data);
            alert(`❌ Error saving current best: ${data.error}`);
        });

        // Include existing chart and metrics functions
        function updateBestIndividualsLog(logData) {
            const logContainer = document.getElementById('bestIndividualsLog');

            if (!logData || logData.length === 0) {
                logContainer.innerHTML = '<div class="text-muted">No data yet...</div>';
                return;
            }

            const logHtml = logData.map(entry => {
                const metricsText = Object.entries(entry.metrics)
                    .map(([key, value]) => `${key}=${value.toFixed(4)}`)
                    .join(', ');
                return `<div>Gen ${entry.generation}: ${metricsText}</div>`;
            }).join('');

            logContainer.innerHTML = logHtml;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateObjectivesChart(bestIndividualsLog) {
            const container = document.getElementById('objectivesChart');

            if (!bestIndividualsLog || bestIndividualsLog.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No objectives data available</div>';
                return;
            }

            const objectiveNames = Object.keys(bestIndividualsLog[0].metrics);

            const series = objectiveNames.map(objName => {
                const data = bestIndividualsLog.map(entry => [entry.generation, entry.metrics[objName]]);

                let color = '#2196F3';
                if (objName.toLowerCase().includes('profit')) {
                    color = '#00C851';
                } else if (objName.toLowerCase().includes('loss')) {
                    color = '#ff4444';
                } else if (objName.toLowerCase().includes('losing')) {
                    color = '#ff9800';
                }

                return {
                    name: objName,
                    data: data,
                    color: color,
                    lineWidth: 2,
                    marker: { enabled: true, radius: 4 }
                };
            });

            const chartConfig = {
                chart: { type: 'line' },
                title: { text: 'Objective Functions Evolution' },
                xAxis: {
                    title: { text: 'Generation' },
                    min: 1,
                    tickInterval: 1
                },
                yAxis: { title: { text: 'Objective Value' } },
                tooltip: {
                    shared: true,
                    crosshairs: true,
                    pointFormat: '<b>{series.name}:</b> {point.y:.4f}<br/>'
                },
                legend: { enabled: true, align: 'bottom' },
                series: series,
                plotOptions: {
                    line: {
                        connectNulls: false,
                        marker: { enabled: true }
                    }
                }
            };

            if (charts.objectives) {
                charts.objectives.destroy();
            }
            charts.objectives = Highcharts.chart(container, chartConfig);
        }

        function updateParallelCoordsChart(eliteData, objectiveNames) {
            if (!eliteData || eliteData.length === 0 || !objectiveNames || objectiveNames.length === 0) {
                if (parallelCoordsChart) {
                    parallelCoordsChart.destroy();
                    parallelCoordsChart = null;
                }
                document.getElementById('parallelCoordsChart').innerHTML = `
                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                        <i class="fas fa-chart-line me-2"></i>No elite data available
                    </div>
                `;
                return;
            }

            const colors = Highcharts.getOptions().colors;
            const colorCount = colors.length;

            const chartConfig = {
                chart: {
                    type: 'line',
                    parallelCoordinates: true,
                    parallelAxes: {
                        lineWidth: 2,
                        gridlinesWidth: 1,
                        title: {
                            style: { fontWeight: 'bold', fontSize: '12px' }
                        }
                    }
                },
                title: {
                    text: `Elite Population Analysis (${eliteData.length} Individuals)`,
                    style: { fontSize: '14px', fontWeight: 'bold' }
                },
                plotOptions: {
                    series: {
                        animation: { duration: 500 },
                        lineWidth: 2.5,
                        opacity: 0.75,
                        states: {
                            hover: { lineWidth: 4, opacity: 1 }
                        },
                        marker: {
                            enabled: false,
                            states: {
                                hover: { enabled: true, radius: 4 }
                            }
                        }
                    }
                },
                tooltip: {
                    formatter: function() {
                        let tooltipText = '<b>Elite Individual #' + (this.series.index + 1) + '</b><br/>';
                        const individualData = eliteData[this.series.index];
                        objectiveNames.forEach(function(objName, i) {
                            tooltipText += objName + ': ' + Highcharts.numberFormat(individualData[i], 4) + '<br/>';
                        });
                        return tooltipText;
                    }
                },
                legend: { enabled: false },
                credits: { enabled: false },
                xAxis: objectiveNames.map((objName, index) => ({
                    lineWidth: 0,
                    labels: { enabled: false },
                    title: {
                        text: objName,
                        style: { fontWeight: 'bold', fontSize: '11px' }
                    }
                })),
                yAxis: objectiveNames.map((objName, index) => {
                    const values = eliteData.map(elite => elite[index]);
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const padding = (max - min) * 0.1;

                    return {
                        lineWidth: 1,
                        min: min - padding,
                        max: max + padding,
                        title: { text: '', style: { fontSize: '10px' } },
                        labels: {
                            format: '{value:.3f}',
                            style: { fontSize: '9px' }
                        }
                    };
                }),
                series: eliteData.map((elite, index) => ({
                    name: `Elite ${index + 1}`,
                    data: elite.map((value, objIndex) => [objIndex, value]),
                    color: colors[index % colorCount],
                    lineWidth: index === 0 ? 3 : 2.5,
                    opacity: index === 0 ? 0.9 : 0.75
                }))
            };

            if (parallelCoordsChart) {
                parallelCoordsChart.destroy();
            }

            parallelCoordsChart = Highcharts.chart('parallelCoordsChart', chartConfig);
        }

        function createTradeDistributionHistograms(tradeData) {
            if (!tradeData || tradeData.length === 0) {
                // Clear histograms if no data
                document.getElementById('winningTradesHistogram').innerHTML = `
                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                        <i class="fas fa-chart-bar me-2"></i>No trade data available
                    </div>
                `;
                document.getElementById('losingTradesHistogram').innerHTML = `
                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                        <i class="fas fa-chart-bar me-2"></i>No trade data available
                    </div>
                `;
                return;
            }

            // Separate winning and losing trades
            const winningTrades = tradeData.filter(trade => trade.trade_pnl > 0).map(trade => trade.trade_pnl);
            const losingTrades = tradeData.filter(trade => trade.trade_pnl < 0).map(trade => trade.trade_pnl);

            // Create histograms
            createHistogram('winningTradesHistogram', winningTrades, 'Winning Trades Distribution', '#28a745', 'Percentage Gain (%)', 'positive');
            createHistogram('losingTradesHistogram', losingTrades, 'Losing Trades Distribution', '#dc3545', 'Percentage Loss (%)', 'negative');
        }

        function createHistogram(containerId, data, title, color, xAxisTitle, type) {
            if (!data || data.length === 0) {
                document.getElementById(containerId).innerHTML = `
                    <div class="text-muted text-center d-flex align-items-center justify-content-center h-100">
                        <i class="fas fa-chart-bar me-2"></i>No ${type} trades yet
                    </div>
                `;
                return;
            }

            // Calculate bin size and range
            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            const range = maxVal - minVal;
            
            // Use appropriate bin size based on data range
            let binSize;
            if (range <= 5) binSize = 0.25;
            else if (range <= 10) binSize = 0.5;
            else if (range <= 20) binSize = 1.0;
            else binSize = 2.0;

            // Create bins
            const binStart = Math.floor(minVal / binSize) * binSize;
            const binEnd = Math.ceil(maxVal / binSize) * binSize;
            const bins = [];
            
            for (let i = binStart; i <= binEnd; i += binSize) {
                bins.push({
                    start: parseFloat(i.toFixed(2)),
                    end: parseFloat((i + binSize).toFixed(2)),
                    count: 0,
                    label: `${i.toFixed(1)}% to ${(i + binSize).toFixed(1)}%`
                });
            }

            // Count trades in each bin
            data.forEach(value => {
                const binIndex = Math.floor((value - binStart) / binSize);
                if (binIndex >= 0 && binIndex < bins.length) {
                    bins[binIndex].count++;
                }
            });

            // Prepare chart data
            const categories = bins.map(bin => `${bin.start.toFixed(1)}% to ${bin.end.toFixed(1)}%`);
            const seriesData = bins.map(bin => bin.count);

            const chartConfig = {
                chart: {
                    type: 'column',
                    backgroundColor: 'white'
                },
                title: {
                    text: title,
                    style: { fontSize: '14px', fontWeight: 'bold' }
                },
                xAxis: {
                    categories: categories,
                    title: { text: xAxisTitle },
                    labels: {
                        rotation: -45,
                        style: { fontSize: '10px' }
                    }
                },
                yAxis: {
                    title: { text: 'Number of Trades' },
                    min: 0,
                    allowDecimals: false
                },
                tooltip: {
                    formatter: function() {
                        return `<b>${this.x}</b><br/>Number of trades: <b>${this.y}</b>`;
                    }
                },
                legend: { enabled: false },
                credits: { enabled: false },
                plotOptions: {
                    column: {
                        borderWidth: 1,
                        borderColor: '#ffffff',
                        dataLabels: {
                            enabled: true,
                            style: { fontSize: '10px' }
                        }
                    }
                },
                series: [{
                    name: 'Trades',
                    data: seriesData,
                    color: color
                }]
            };

            // Destroy existing chart if it exists
            if (charts[containerId]) {
                charts[containerId].destroy();
            }

            // Create new chart
            charts[containerId] = Highcharts.chart(containerId, chartConfig);
        }

        function updateMetricsTable(generation, chartData) {
            const tableBody = document.getElementById('metricsTableBody');

            const trades = chartData.trade_history || [];
            const totalTrades = trades.length;

            const completedTrades = chartData.pnl_history || [];
            let winningTrades = 0;
            let losingTrades = 0;
            let totalWinPnL = 0;
            let totalLossPnL = 0;

            completedTrades.forEach(trade => {
                if (trade.trade_pnl > 0) {
                    winningTrades++;
                    totalWinPnL += trade.trade_pnl;
                } else if (trade.trade_pnl < 0) {
                    losingTrades++;
                    totalLossPnL += trade.trade_pnl;
                }
            });

            const totalPnL = completedTrades.length > 0
                ? completedTrades[completedTrades.length - 1].cumulative_pnl
                : 0;

            const avgWin = winningTrades > 0 ? totalWinPnL / winningTrades : 0;
            const avgLoss = losingTrades > 0 ? totalLossPnL / losingTrades : 0;

            const generationData = {
                generation,
                totalTrades,
                winningTrades,
                losingTrades,
                totalPnL,
                avgWin,
                avgLoss
            };

            const existingIndex = generationMetrics.findIndex(g => g.generation === generation);
            if (existingIndex >= 0) {
                generationMetrics[existingIndex] = generationData;
            } else {
                generationMetrics.push(generationData);
            }

            generationMetrics.sort((a, b) => a.generation - b.generation);

            if (generationMetrics.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-muted">No data yet...</td></tr>';
                return;
            }

            const tableRows = generationMetrics.map(data => `
                <tr>
                    <td><strong>${data.generation}</strong></td>
                    <td>${data.totalTrades}</td>
                    <td class="text-success">${data.winningTrades}</td>
                    <td class="text-danger">${data.losingTrades}</td>
                    <td class="${data.totalPnL >= 0 ? 'text-success' : 'text-danger'}">${data.totalPnL.toFixed(2)}%</td>
                    <td class="text-success">${data.avgWin.toFixed(2)}%</td>
                    <td class="text-danger">${data.avgLoss.toFixed(2)}%</td>
                </tr>
            `).join('');

            tableBody.innerHTML = tableRows;

            // Update trade distribution histograms
            createTradeDistributionHistograms(completedTrades);

            const tableContainer = document.querySelector('.table-container');
            tableContainer.scrollTop = tableContainer.scrollHeight;
        }

        async function saveGenerationMetrics() {
            try {
                const response = await fetch('/api/save_generation_metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test_name: currentTestName,
                        generation_metrics: generationMetrics,
                        timestamp: currentTimestamp
                    })
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`✅ Saved ${result.metrics_count} generation metrics to ${result.file_path}`);
                } else {
                    console.error('❌ Error saving generation metrics:', result.error);
                }
            } catch (error) {
                console.error('❌ Error saving generation metrics:', error);
            }
        }

        function showResultsInfo(resultsInfo) {
            const filesList = resultsInfo.files_created.map(file =>
                `• ${file.split('/').pop()}`
            ).join('\n');

            const message = `🎉 Optimization Complete! 🎉

Results saved to: ${resultsInfo.results_dir}

Files created:
${filesList}

✅ Best monitor configuration (JSON)
✅ Objectives evolution (CSV)
✅ Generation metrics summary (CSV)
✅ Original GA config (JSON)
✅ Summary report (TXT)`;

            alert(message);
        }
    </script>
</body>
</html>