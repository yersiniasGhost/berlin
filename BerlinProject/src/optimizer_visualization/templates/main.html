<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Algorithm Optimization Visualization</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container-fluid {
            max-width: 1400px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 1rem 1rem;
        }

        .upload-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background-color: #e7ebff;
        }

        .config-summary {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-ready { background-color: #28a745; }
        .status-uploading { background-color: #ffc107; }
        .status-processing { background-color: #17a2b8; }
        .status-error { background-color: #dc3545; }

        .file-info {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .loading-spinner {
            display: none;
        }

        .loading-spinner.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header text-center">
            <h1><i class="fas fa-dna me-2"></i>Genetic Algorithm Optimization</h1>
            <p class="mb-0">Upload configurations and visualize trading strategy evolution</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h3 class="mb-4"><i class="fas fa-upload me-2"></i>Configuration Upload</h3>

            <div class="row">
                <!-- GA Config Upload -->
                <div class="col-md-6">
                    <h5>GA Configuration</h5>
                    <div class="file-upload-area" id="gaUploadArea">
                        <i class="fas fa-file-code fa-3x text-muted mb-3"></i>
                        <p>Drop GA config file here or click to browse</p>
                        <input type="file" id="gaFileInput" accept=".json" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('gaFileInput').click()">
                            <i class="fas fa-folder-open me-1"></i>Browse Files
                        </button>
                    </div>
                    <div id="gaFileInfo" class="file-info" style="display: none;"></div>
                </div>

                <!-- Data Config Upload -->
                <div class="col-md-6">
                    <h5>Data Configuration</h5>
                    <div class="file-upload-area" id="dataUploadArea">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <p>Drop data config file here or click to browse</p>
                        <input type="file" id="dataFileInput" accept=".json" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('dataFileInput').click()">
                            <i class="fas fa-folder-open me-1"></i>Browse Files
                        </button>
                    </div>
                    <div id="dataFileInfo" class="file-info" style="display: none;"></div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <button id="loadConfigsBtn" class="btn btn-primary me-2" disabled>
                        <i class="fas fa-upload me-1"></i> Load Configurations
                    </button>
                    <button id="runOptimizationBtn" class="btn btn-success" disabled>
                        <i class="fas fa-play me-1"></i> Run Optimization (1 Epoch)
                    </button>
                    <span id="optimizationStatus" class="ms-3"></span>
                </div>
            </div>

            <!-- Configuration Summary -->
            <div id="configSummary" class="config-summary" style="display: none;">
                <h5>Configuration Summary</h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>GA Configuration</h6>
                        <div id="gaSummary"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Data Configuration</h6>
                        <div id="dataSummary"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" style="display: none;">
            <!-- Main Candlestick Chart -->
            <div class="chart-container">
                <h4>Price Chart with Buy/Sell Signals</h4>
                <div id="candlestickChart" style="height: 500px;"></div>
            </div>

            <!-- P&L Chart -->
            <div class="chart-container">
                <h4>Cumulative P&L (%)</h4>
                <div id="pnlChart" style="height: 300px;"></div>
            </div>

            <!-- Bar Scores Charts -->
            <div class="chart-container">
                <h4>Bar Scores Evolution</h4>
                <div id="barChartsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let gaConfigPath = null;
        let dataConfigPath = null;
        let optimizationData = null;
        let candlestickChart = null;
        let pnlChart = null;

        // File upload handling
        function setupFileUpload(inputId, uploadAreaId, fileInfoId, fileType) {
            const input = document.getElementById(inputId);
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInfo = document.getElementById(fileInfoId);

            // Click to upload
            uploadArea.addEventListener('click', () => input.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    handleFileUpload(files[0], fileType, fileInfo);
                }
            });

            // File input change
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], fileType, fileInfo);
                }
            });
        }

        function handleFileUpload(file, fileType, fileInfoDiv) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('file_type', fileType);

            updateAppStatus(`Uploading ${fileType} config...`, 'uploading');

            fetch('/api/upload_file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileInfoDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span><strong>Uploaded:</strong> ${data.filename}</span>
                        </div>
                    `;
                    fileInfoDiv.style.display = 'block';

                    if (fileType === 'ga') {
                        gaConfigPath = data.file_path;
                    } else {
                        dataConfigPath = data.file_path;
                    }

                    checkConfigsReady();
                    updateAppStatus(`${fileType.toUpperCase()} config uploaded`, 'ready');
                } else {
                    alert('Upload error: ' + data.error);
                    updateAppStatus('Upload failed', 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload error: ' + error.message);
                updateAppStatus('Upload failed', 'error');
            });
        }

        function checkConfigsReady() {
            const loadBtn = document.getElementById('loadConfigsBtn');
            if (gaConfigPath && dataConfigPath) {
                loadBtn.disabled = false;
            }
        }

        function updateAppStatus(message, status) {
            // This could update a status indicator if you want to add one
            console.log(`Status: ${message} (${status})`);
        }

        // Initialize file uploads
        setupFileUpload('gaFileInput', 'gaUploadArea', 'gaFileInfo', 'ga');
        setupFileUpload('dataFileInput', 'dataUploadArea', 'dataFileInfo', 'data');

        // Load configurations
        document.getElementById('loadConfigsBtn').addEventListener('click', async function() {
            try {
                updateAppStatus('Loading configurations...', 'processing');

                const response = await fetch('/api/load_configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ga_config_path: gaConfigPath,
                        data_config_path: dataConfigPath
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show configuration summary
                    displayConfigSummary(result.summary);

                    // Enable optimization button
                    document.getElementById('runOptimizationBtn').disabled = false;

                    updateAppStatus('Configurations loaded', 'ready');
                } else {
                    alert('Error loading configurations: ' + result.error);
                    updateAppStatus('Configuration load failed', 'error');
                }
            } catch (error) {
                console.error('Error loading configs:', error);
                alert('Error loading configurations: ' + error.message);
                updateAppStatus('Configuration load failed', 'error');
            }
        });

        function displayConfigSummary(summary) {
            const gaSummary = document.getElementById('gaSummary');
            const dataSummary = document.getElementById('dataSummary');

            gaSummary.innerHTML = `
                <p><strong>Test Name:</strong> ${summary.ga_config.test_name}</p>
                <p><strong>Population Size:</strong> ${summary.ga_config.population_size}</p>
                <p><strong>Generations:</strong> ${summary.ga_config.generations}</p>
                <p><strong>Mutation Rate:</strong> ${summary.ga_config.mutation_rate}</p>
            `;

            dataSummary.innerHTML = `
                <p><strong>Ticker:</strong> ${summary.data_config.ticker}</p>
                <p><strong>Start Date:</strong> ${summary.data_config.start_date}</p>
                <p><strong>End Date:</strong> ${summary.data_config.end_date}</p>
                <p><strong>Time Increment:</strong> ${summary.data_config.time_increment} minute(s)</p>
            `;

            document.getElementById('configSummary').style.display = 'block';
        }

        // Run optimization
        document.getElementById('runOptimizationBtn').addEventListener('click', async function() {
            try {
                updateAppStatus('Running optimization...', 'processing');
                document.getElementById('optimizationStatus').innerHTML =
                    '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Running optimization...</span>';

                const response = await fetch('/api/run_optimization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ga_config_path: gaConfigPath,
                        data_config_path: dataConfigPath
                    })
                });

                const result = await response.json();

                if (result.success) {
                    optimizationData = result;
                    document.getElementById('chartsSection').style.display = 'block';

                    // Create charts
                    createCandlestickChart();
                    createPnLChart();  // Add P&L chart
                    createBarScoreCharts();

                    updateAppStatus('Optimization complete', 'ready');
                    document.getElementById('optimizationStatus').innerHTML =
                        `<span class="text-success"><i class="fas fa-check me-1"></i>Complete - ${result.total_candles} candles, ${result.triggers.length} signals</span>`;

                } else {
                    alert('Optimization error: ' + result.error);
                    updateAppStatus('Optimization failed', 'error');
                    document.getElementById('optimizationStatus').innerHTML =
                        '<span class="text-danger"><i class="fas fa-times me-1"></i>Failed</span>';
                }

            } catch (error) {
                console.error('Error running optimization:', error);
                updateAppStatus('Optimization failed', 'error');
                document.getElementById('optimizationStatus').innerHTML =
                    '<span class="text-danger"><i class="fas fa-times me-1"></i>Failed</span>';
                alert('Error running optimization: ' + error.message);
            }
        });

        function createCandlestickChart() {
            const buyTriggers = optimizationData.triggers.filter(t => t.type === 'buy');
            const sellTriggers = optimizationData.triggers.filter(t => t.type === 'sell');

            candlestickChart = Highcharts.stockChart('candlestickChart', {
                title: {
                    text: `${optimizationData.ticker} - Price with Buy/Sell Signals`
                },

                rangeSelector: {
                    selected: 1
                },

                plotOptions: {
                    candlestick: {
                        dataGrouping: {
                            enabled: false
                        }
                    },
                    scatter: {
                        dataGrouping: {
                            enabled: false
                        }
                    }
                },

                yAxis: [{
                    labels: {
                        align: 'right',
                        x: -3
                    },
                    title: {
                        text: 'Price ($)'
                    },
                    height: '100%',
                    lineWidth: 2
                }],

                tooltip: {
                    split: true
                },

                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            if (pnlChart && e.trigger !== 'syncExtremes') {
                                pnlChart.xAxis[0].setExtremes(e.min, e.max, true, false, { trigger: 'syncExtremes' });
                            }
                        }
                    }
                },

                series: [{
                    type: 'candlestick',
                    name: optimizationData.ticker,
                    data: optimizationData.candlestick_data,
                    color: '#ff4444',
                    upColor: '#00aa00',
                    lineColor: '#ff4444',
                    upLineColor: '#00aa00',
                    dataGrouping: {
                        enabled: false
                    }
                }, {
                    type: 'scatter',
                    name: 'Buy Signals',
                    data: buyTriggers.map(t => {
                        // Find the corresponding candle to position arrow below it
                        const candleData = optimizationData.candlestick_data.find(c =>
                            Math.abs(c[0] - t.timestamp) < 60000 // Within 1 minute
                        );
                        const lowPrice = candleData ? candleData[3] : t.price; // Use candle low, fallback to trade price

                        return {
                            x: t.timestamp,
                            y: lowPrice * 0.998, // Position 0.2% below candle low
                            actualPrice: t.price, // Store the actual trade price
                            reason: t.reason || 'BUY'
                        };
                    }),
                    marker: {
                        symbol: 'triangle',
                        fillColor: '#00aa00',
                        lineColor: '#006600',
                        lineWidth: 1,
                        radius: 6
                    },
                    tooltip: {
                        pointFormat: '<b>BUY SIGNAL</b><br/>Entry Price: <b>${point.actualPrice:.2f}</b><br/>Arrow Position: ${point.y:.2f}<br/>Reason: {point.reason}'
                    },
                    dataGrouping: {
                        enabled: false
                    }
                }, {
                    type: 'scatter',
                    name: 'Sell Signals',
                    data: sellTriggers.map(t => {
                        // Find the corresponding candle to position arrow above it
                        const candleData = optimizationData.candlestick_data.find(c =>
                            Math.abs(c[0] - t.timestamp) < 60000 // Within 1 minute
                        );
                        const highPrice = candleData ? candleData[2] : t.price; // Use candle high, fallback to trade price

                        return {
                            x: t.timestamp,
                            y: highPrice * 1.002, // Position 0.2% above candle high
                            actualPrice: t.price, // Store the actual trade price
                            reason: t.reason || 'SELL'
                        };
                    }),
                    marker: {
                        symbol: 'triangle-down',
                        fillColor: '#ff4444',
                        lineColor: '#cc0000',
                        lineWidth: 1,
                        radius: 6
                    },
                    tooltip: {
                        pointFormat: '<b>SELL SIGNAL</b><br/>Exit Price: <b>${point.actualPrice:.2f}</b><br/>Arrow Position: ${point.y:.2f}<br/>Reason: {point.reason}'
                    },
                    dataGrouping: {
                        enabled: false
                    }
                }]
            });
        }

        function createPnLChart() {
            if (!optimizationData.pnl_history || optimizationData.pnl_history.length === 0) {
                document.getElementById('pnlChart').innerHTML = '<div class="text-center py-4"><div class="text-muted">No P&L data available</div></div>';
                return;
            }

            // Create expanded PnL data with 1-minute intervals
            const expandedPnlData = [];
            let currentPnl = 0.0;

            // Get all candlestick timestamps for reference
            const allTimestamps = optimizationData.candlestick_data.map(candle => candle[0]);
            allTimestamps.sort((a, b) => a - b);

            // Create a map of trade exit timestamps to PnL values
            const exitToPnlMap = {};
            optimizationData.pnl_history.forEach(entry => {
                exitToPnlMap[entry.timestamp] = entry.cumulative_pnl;
            });

            // Create minute-by-minute PnL data
            allTimestamps.forEach(timestamp => {
                // Check if this timestamp has a PnL change (trade exit)
                if (exitToPnlMap[timestamp] !== undefined) {
                    currentPnl = exitToPnlMap[timestamp];
                }
                expandedPnlData.push([timestamp, currentPnl]);
            });

            pnlChart = Highcharts.stockChart('pnlChart', {
                title: {
                    text: `Portfolio Performance - Cumulative P&L`
                },

                rangeSelector: {
                    selected: 1
                },

                plotOptions: {
                    line: {
                        dataGrouping: {
                            enabled: false  // Disable grouping - CRITICAL for 1-minute intervals
                        }
                    }
                },

                yAxis: {
                    title: {
                        text: 'Cumulative P&L (%)'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'gray',
                        dashStyle: 'dash',
                        width: 1,
                        label: {
                            text: 'Break Even',
                            align: 'right'
                        }
                    }]
                },

                // Add event handlers for zoom synchronization
                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            // Sync with candlestick chart when user zooms/pans P&L chart
                            if (candlestickChart && e.trigger !== 'syncExtremes') {
                                candlestickChart.xAxis[0].setExtremes(e.min, e.max, true, false, { trigger: 'syncExtremes' });
                            }
                        }
                    }
                },

                tooltip: {
                    pointFormat: '<b>P&L:</b> {point.y:.2f}%'
                },

                series: [{
                    name: 'Cumulative P&L',
                    data: expandedPnlData,
                    color: '#2E86AB',
                    lineWidth: 2,
                    marker: {
                        enabled: false,  // Hide markers for cleaner look
                        radius: 2,
                        fillColor: '#2E86AB'
                    },
                    dataGrouping: {
                        enabled: false  // CRITICAL: Disable grouping to maintain 1-minute intervals
                    },
                    step: true  // Step chart to show flat lines during holding periods
                }]
            });
        }

function createBarScoreCharts() {
    const barChartsContainer = document.getElementById('barChartsContainer');
    if (!barChartsContainer) {
        console.error('Bar charts container not found');
        return;
    }

    // Clear existing charts
    barChartsContainer.innerHTML = '';

    // Check if we have bar scores data
    if (!optimizationData.bar_scores_history || optimizationData.bar_scores_history.length === 0) {
        barChartsContainer.innerHTML = '<div class="text-center py-4"><div class="text-muted">No bar scores data available</div></div>';
        return;
    }

    // Get all unique bar names
    const barNames = new Set();
    optimizationData.bar_scores_history.forEach(entry => {
        Object.keys(entry.scores).forEach(barName => barNames.add(barName));
    });

    console.log(`Creating charts for ${barNames.size} bars:`, Array.from(barNames));
    console.log('Threshold config:', optimizationData.threshold_config);

    // Create a combined chart with all bar scores
    const combinedChartDiv = document.createElement('div');
    combinedChartDiv.id = 'combinedBarChart';
    combinedChartDiv.style.height = '400px';
    combinedChartDiv.style.marginBottom = '30px';
    barChartsContainer.appendChild(combinedChartDiv);

    // Enhanced color assignment
    const bullColors = ['#28a745', '#20c997', '#17a2b8', '#6f42c1'];
    const bearColors = ['#dc3545', '#fd7e14', '#e83e8c', '#6c757d'];
    const triggerColors = ['#8085e9', '#6610f2', '#e83e8c', '#20c997'];
    const defaultColors = ['#007bff', '#6c757d', '#28a745', '#ffc107'];

    let bullIndex = 0, bearIndex = 0, triggerIndex = 0, defaultIndex = 0;

    // Prepare series data for all bars
    const seriesData = [];

    barNames.forEach(barName => {
        // Prepare data for this bar
        const barData = optimizationData.bar_scores_history.map(entry => [
            entry.timestamp,
            entry.scores[barName] || 0
        ]);

        // Determine color and style based on bar name with variety
        let color = '#7cb5ec';
        let dashStyle = 'Solid';
        let lineWidth = 2;

        if (barName.includes('bull') || barName.includes('entry')) {
            color = bullColors[bullIndex % bullColors.length];
            bullIndex++;
            lineWidth = 2;
        } else if (barName.includes('bear') || barName.includes('exit')) {
            color = bearColors[bearIndex % bearColors.length];
            bearIndex++;
            lineWidth = 2;
        } else if (barName.includes('trigger')) {
            color = triggerColors[triggerIndex % triggerColors.length];
            dashStyle = 'Dash';
            triggerIndex++;
            lineWidth = 1.5;
        } else {
            color = defaultColors[defaultIndex % defaultColors.length];
            defaultIndex++;
            lineWidth = 1.5;
        }

        seriesData.push({
            name: barName,
            data: barData,
            color: color,
            dashStyle: dashStyle,
            lineWidth: lineWidth,
            marker: {
                enabled: false,
                radius: 3,
                symbol: 'circle'
            },
            dataGrouping: {
                enabled: false
            }
        });
    });

    // BUILD DYNAMIC THRESHOLD PLOT LINES
    const plotLines = [];

    // Add threshold lines for each bar that has a configured threshold
    if (optimizationData.threshold_config) {
        Object.entries(optimizationData.threshold_config).forEach(([barName, config]) => {
            const threshold = config.threshold;
            const type = config.type;

            // Determine line style based on type
            let color = '#999';
            let width = 1;
            let dashStyle = 'Dash';
            let labelText = `${barName}: ${threshold.toFixed(3)}`;

            if (type === 'entry') {
                color = '#28a745'; // Green
                width = 2;
                dashStyle = 'Solid';
                labelText = `üìà ${barName}: ${threshold.toFixed(3)} (Entry)`;
            } else if (type === 'exit') {
                color = '#dc3545'; // Red
                width = 2;
                dashStyle = 'Solid';
                labelText = `üìâ ${barName}: ${threshold.toFixed(3)} (Exit)`;
            }

            plotLines.push({
                value: threshold,
                color: color,
                dashStyle: dashStyle,
                width: width,
                label: {
                    text: labelText,
                    align: 'right',
                    style: {
                        color: color,
                        fontWeight: 'bold',
                        fontSize: '11px'
                    }
                },
                zIndex: 5 // Show above the data lines
            });
        });
    }

    // Add standard reference lines
    plotLines.push({
        value: 0.5,
        color: '#999',
        dashStyle: 'dot',
        width: 1,
        label: {
            text: 'Neutral (0.5)',
            align: 'left',
            style: {
                color: '#999',
                fontSize: '10px'
            }
        },
        zIndex: 1
    });

    // Create the combined bar scores chart
    const combinedBarChart = Highcharts.stockChart('combinedBarChart', {
        title: {
            text: 'Bar Scores Over Time with Optimized Thresholds'
        },

        rangeSelector: {
            selected: 1
        },

        plotOptions: {
            line: {
                dataGrouping: {
                    enabled: false
                }
            }
        },

        xAxis: {
            events: {
                afterSetExtremes: function(e) {
                    // Sync with main candlestick chart
                    if (candlestickChart && e.trigger !== 'syncExtremes') {
                        candlestickChart.xAxis[0].setExtremes(e.min, e.max, true, false, { trigger: 'syncExtremes' });
                    }
                    // Sync with P&L chart
                    if (pnlChart && e.trigger !== 'syncExtremes') {
                        pnlChart.xAxis[0].setExtremes(e.min, e.max, true, false, { trigger: 'syncExtremes' });
                    }
                }
            }
        },

        yAxis: {
            title: {
                text: 'Bar Score'
            },
            min: 0,
            max: 1.2,
            plotLines: plotLines  // Use the dynamically generated plot lines
        },

        tooltip: {
            shared: true,
            crosshairs: true,
            formatter: function() {
                let tooltipContent = '<b>' + Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '</b><br/>';

                // Group bars by type for better organization
                const bullBars = [];
                const bearBars = [];
                const triggerBars = [];
                const otherBars = [];

                this.points.forEach(point => {
                    const barInfo = {
                        name: point.series.name,
                        value: point.y.toFixed(3),
                        color: point.color,
                        y: point.y
                    };

                    // Get threshold for this bar
                    const thresholdInfo = optimizationData.threshold_config?.[point.series.name];
                    if (thresholdInfo) {
                        barInfo.threshold = thresholdInfo.threshold.toFixed(3);
                        barInfo.thresholdType = thresholdInfo.type;
                    }

                    if (point.series.name.includes('bull') || point.series.name.includes('entry')) {
                        bullBars.push(barInfo);
                    } else if (point.series.name.includes('bear') || point.series.name.includes('exit')) {
                        bearBars.push(barInfo);
                    } else if (point.series.name.includes('trigger')) {
                        triggerBars.push(barInfo);
                    } else {
                        otherBars.push(barInfo);
                    }
                });

                // Display bull bars
                if (bullBars.length > 0) {
                    tooltipContent += '<br/><b>üü¢ BULLISH BARS:</b><br/>';
                    bullBars.forEach(bar => {
                        const threshold = bar.threshold ? parseFloat(bar.threshold) : 0.7;
                        const status = bar.y >= threshold ? ' üöÄ SIGNAL' : bar.y >= 0.5 ? ' üìà BUILDING' : ' üò¥ WEAK';
                        const thresholdText = bar.threshold ? ` (threshold: ${bar.threshold})` : '';
                        tooltipContent += `<span style="color:${bar.color}">‚óè</span> ${bar.name}: <b>${bar.value}</b>${status}${thresholdText}<br/>`;
                    });
                }

                // Display bear bars
                if (bearBars.length > 0) {
                    tooltipContent += '<br/><b>üî¥ BEARISH BARS:</b><br/>';
                    bearBars.forEach(bar => {
                        const threshold = bar.threshold ? parseFloat(bar.threshold) : 0.6;
                        const status = bar.y >= threshold ? ' üìâ SIGNAL' : bar.y >= 0.3 ? ' ‚ö†Ô∏è BUILDING' : ' üò¥ WEAK';
                        const thresholdText = bar.threshold ? ` (threshold: ${bar.threshold})` : '';
                        tooltipContent += `<span style="color:${bar.color}">‚óè</span> ${bar.name}: <b>${bar.value}</b>${status}${thresholdText}<br/>`;
                    });
                }

                // Display trigger bars
                if (triggerBars.length > 0) {
                    tooltipContent += '<br/><b>üü£ TRIGGER BARS:</b><br/>';
                    triggerBars.forEach(bar => {
                        const threshold = bar.threshold ? parseFloat(bar.threshold) : 0.5;
                        const status = bar.y >= threshold ? ' ‚ö° ACTIVE' : ' üí§ INACTIVE';
                        const thresholdText = bar.threshold ? ` (threshold: ${bar.threshold})` : '';
                        tooltipContent += `<span style="color:${bar.color}">‚óè</span> ${bar.name}: <b>${bar.value}</b>${status}${thresholdText}<br/>`;
                    });
                }

                // Display other bars
                if (otherBars.length > 0) {
                    tooltipContent += '<br/><b>üìä OTHER BARS:</b><br/>';
                    otherBars.forEach(bar => {
                        const thresholdText = bar.threshold ? ` (threshold: ${bar.threshold})` : '';
                        tooltipContent += `<span style="color:${bar.color}">‚óè</span> ${bar.name}: <b>${bar.value}</b>${thresholdText}<br/>`;
                    });
                }

                return tooltipContent;
            }
        },

        legend: {
            enabled: true,
            layout: 'horizontal',
            align: 'center',
            verticalAlign: 'bottom'
        },

        series: seriesData
    });

    // Store reference for synchronization
    window.combinedBarChart = combinedBarChart;
}

        console.log('Genetic Algorithm Visualization App initialized.');
    </script>
</body>
</html>