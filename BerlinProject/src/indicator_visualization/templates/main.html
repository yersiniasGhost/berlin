<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicator Visualizer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Highcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/highcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/modules/stock.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/indicators/indicators.min.js"></script>

    <style>
        .config-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }

        .status-message {
            margin-top: 15px;
        }

        .loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3">
                    <h1><i class="fas fa-chart-line me-2"></i>Indicator Visualizer</h1>
                    <span class="badge bg-success">IndicatorProcessor Data</span>
                </div>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="row">
            <div class="col-md-4">
                <div class="config-panel">
                    <h5>Configuration</h5>

                    <!-- Stock Symbol -->
                    <div class="mb-3">
                        <label for="ticker" class="form-label">Stock Symbol</label>
                        <input type="text" class="form-control" id="ticker" placeholder="e.g., AAPL" value="NVDA">
                    </div>

                    <!-- Date Range -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>

                    <!-- Indicator Configuration JSON -->
                    <div class="mb-3">
                        <label for="indicatorConfig" class="form-label">Indicator Configuration (GA Format)</label>
                        <textarea class="form-control" id="indicatorConfig" rows="15" placeholder="Enter indicator configs as JSON array..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="visualizeBtn">
                            <i class="fas fa-chart-area me-2"></i>Visualize Indicators
                        </button>
                        <button class="btn btn-secondary" id="loadExampleBtn">
                            <i class="fas fa-file-code me-2"></i>Load Example Config
                        </button>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="text-center loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing data...</p>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="col-md-8">
                <div id="chartsContainer" style="display: none;">
                    <!-- Main Candlestick Chart -->
                    <div class="chart-container">
                        <h5>Price Chart</h5>
                        <div id="candlestickChart" style="height: 400px;"></div>
                    </div>

                    <!-- Original Working Indicators -->
                    <div class="chart-container">
                        <h5>Raw Indicators (MACD, SMA Values & Triggers)</h5>
                        <div id="indicatorCharts"></div>
                    </div>
                    
                    <!-- Time-Decayed Indicator Charts -->
                    <div class="chart-container">
                        <h5>Time-Decayed Indicators (Processed Values)</h5>
                        <div id="timeDecayedCharts"></div>
                    </div>
                    
                    <!-- Bar Scores -->
                    <div class="chart-container">
                        <h5>Bar Scores (Weighted Combinations)</h5>
                        <div id="barScoreCharts"></div>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div id="welcomeMessage" class="text-center mt-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Visualize IndicatorProcessor Values</h4>
                    <p class="text-muted">View raw indicators, time-decayed values, and bar scores from the IndicatorProcessor.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global chart objects
        let charts = {};

        // Set default dates (last 5 days)
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 5);

            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }

        // Load example configuration
        function loadExampleConfig() {
            const exampleConfig = [
                {
                    "name": "macd1m",
                    "type": "Indicator",
                    "function": "macd_histogram_crossover",
                    "agg_config": "1m-normal",
                    "calc_on_pip": false,
                    "parameters": {
                        "slow": 26,
                        "fast": 12,
                        "signal": 9,
                        "histogram_threshold": 0.0008,
                        "lookback": 50,
                        "trend": "bullish"
                    }
                },
                {
                    "name": "sma20",
                    "type": "Indicator",
                    "function": "sma_crossover",
                    "agg_config": "1m-normal",
                    "calc_on_pip": false,
                    "parameters": {
                        "period": 20,
                        "crossover_value": 0.001,
                        "lookback": 10,
                        "trend": "bullish"
                    }
                }
            ];

            document.getElementById('indicatorConfig').value = JSON.stringify(exampleConfig, null, 2);
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Show loading state
        function showLoading(show = true) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('visualizeBtn').disabled = show;
        }

        // Create candlestick chart
        function createCandlestickChart(data, ticker) {
            const container = document.getElementById('candlestickChart');

            if (charts.candlestick) {
                charts.candlestick.destroy();
            }

            charts.candlestick = Highcharts.stockChart(container, {
                title: {
                    text: `${ticker} - 1 Minute Candles`
                },

                rangeSelector: {
                    selected: 1
                },

                plotOptions: {
                    candlestick: {
                        dataGrouping: {
                            enabled: false
                        }
                    }
                },

                yAxis: {
                    title: {
                        text: 'Price ($)'
                    }
                },

                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            syncAllCharts(e, 'candlestick');
                        }
                    }
                },

                series: [{
                    type: 'candlestick',
                    name: ticker,
                    data: data.candlestick,
                    dataGrouping: {
                        enabled: false
                    }
                }]
            });
        }

        // Create indicator charts (ORIGINAL WORKING VERSION)
        function createIndicatorCharts(indicators) {
            const container = document.getElementById('indicatorCharts');
            container.innerHTML = '';

            // Track which MACD groups we've already processed
            const processedMACDGroups = new Set();

            Object.keys(indicators).forEach(indicatorName => {
                const indicator = indicators[indicatorName];

                // Handle MACD components by grouping them
                if (indicatorName.includes('_macd') || indicatorName.includes('_signal') || indicatorName.includes('_histogram')) {
                    // Extract base name (e.g., "macd1m" from "macd1m_macd")
                    const baseName = indicatorName.replace(/_macd$|_signal$|_histogram$/, '');

                    // Only create chart once per MACD group
                    if (!processedMACDGroups.has(baseName)) {
                        processedMACDGroups.add(baseName);
                        createMACDGroupedChart(baseName, indicators);
                    }
                } else if (indicatorName.includes('_sma')) {
                    // Handle SMA indicators
                    createSMAIndicatorChart(indicatorName, indicator);
                } else {
                    // Handle other indicators
                    createSMAIndicatorChart(indicatorName, indicator);
                }
            });
        }

        // Create MACD grouped chart (ORIGINAL WORKING VERSION)
        function createMACDGroupedChart(baseName, allIndicators) {
            // Create container div for this MACD group
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `
                <h5>${baseName} - MACD Analysis</h5>
                <div id="indicator_${baseName}_macd_group" style="height: 400px;"></div>
            `;
            document.getElementById('indicatorCharts').appendChild(chartDiv);

            const chartId = `indicator_${baseName}_macd_group`;

            // Look for all MACD components with this base name
            const macdData = allIndicators[`${baseName}_macd`];
            const signalData = allIndicators[`${baseName}_signal`];
            const histogramData = allIndicators[`${baseName}_histogram`];
            const triggerData = allIndicators[`${baseName}_triggers`];

            const series = [];

            // Add MACD line
            if (macdData) {
                series.push({
                    name: 'MACD',
                    data: macdData.data,
                    color: '#2E86AB',
                    yAxis: 0,
                    type: 'line'
                });
            }

            // Add Signal line
            if (signalData) {
                series.push({
                    name: 'Signal',
                    data: signalData.data,
                    color: '#A23B72',
                    yAxis: 0,
                    type: 'line'
                });
            }

            // Add Histogram
            if (histogramData) {
                series.push({
                    name: 'Histogram',
                    data: histogramData.data,
                    color: '#F18F01',
                    yAxis: 1,
                    type: 'column'
                });
            }

            // Add trigger points
            if (triggerData && macdData) {
                const triggerPoints = [];
                triggerData.data.forEach((point, index) => {
                    const [timestamp, triggerValue] = point;
                    if (triggerValue === 1 && macdData.data[index]) {
                        const macdValue = macdData.data[index][1];
                        triggerPoints.push([timestamp, macdValue]);
                    }
                });

                series.push({
                    name: 'MACD Triggers',
                    data: triggerPoints,
                    color: '#FF6B35',
                    yAxis: 0,
                    type: 'scatter',
                    marker: {
                        symbol: 'triangle',
                        radius: 6
                    },
                    tooltip: {
                        pointFormat: '<b>MACD Trigger:</b> {point.y:.4f}'
                    }
                });
            }

            charts[chartId] = Highcharts.stockChart(chartId, {
                title: {
                    text: `${baseName} - MACD Components with Triggers`
                },
                rangeSelector: {
                    enabled: false
                },
                yAxis: [{
                    title: {
                        text: 'MACD / Signal'
                    },
                    height: '60%'
                }, {
                    title: {
                        text: 'Histogram'
                    },
                    top: '65%',
                    height: '35%'
                }],
                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            syncAllCharts(e, chartId);
                        }
                    }
                },
                plotOptions: {
                    line: {
                        dataGrouping: { enabled: false }
                    },
                    column: {
                        dataGrouping: { enabled: false }
                    },
                    scatter: {
                        dataGrouping: { enabled: false }
                    }
                },
                series: series
            });
        }

        // Create SMA indicator chart (ORIGINAL WORKING VERSION)
        function createSMAIndicatorChart(indicatorName, indicator) {
            // Create container div for this indicator
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `
                <h5>${indicator.name}</h5>
                <div id="indicator_${indicatorName}" style="height: 300px;"></div>
            `;
            document.getElementById('indicatorCharts').appendChild(chartDiv);

            const chartId = `indicator_${indicatorName}`;

            // Check if this is an SMA indicator with triggers
            const baseName = indicatorName.replace('_sma', '');
            const triggerKey = `${baseName}_triggers`;
            const triggerData = window.lastIndicatorData && window.lastIndicatorData[triggerKey];

            const series = [{
                name: indicator.name,
                data: indicator.data,
                color: '#45B7D1',
                lineWidth: 2
            }];

            // Add trigger points for SMA if available
            if (triggerData) {
                const triggerPoints = [];
                triggerData.data.forEach((point, index) => {
                    const [timestamp, triggerValue] = point;
                    if (triggerValue === 1 && indicator.data[index]) {
                        const smaValue = indicator.data[index][1];
                        triggerPoints.push([timestamp, smaValue]);
                    }
                });

                if (triggerPoints.length > 0) {
                    series.push({
                        name: 'SMA Triggers',
                        data: triggerPoints,
                        color: '#FF6B35',
                        type: 'scatter',
                        marker: {
                            symbol: 'circle',
                            radius: 5
                        },
                        tooltip: {
                            pointFormat: '<b>SMA Trigger:</b> {point.y:.2f}'
                        }
                    });
                }
            }

            charts[chartId] = Highcharts.stockChart(chartId, {
                title: {
                    text: indicator.name + (triggerData ? ' with Triggers' : '')
                },
                rangeSelector: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Value'
                    }
                },
                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            syncAllCharts(e, chartId);
                        }
                    }
                },
                plotOptions: {
                    line: {
                        dataGrouping: { enabled: false }
                    },
                    scatter: {
                        dataGrouping: { enabled: false }
                    }
                },
                series: series
            });
        }

        // Create simple indicator chart
        function createSimpleIndicatorChart(chartKey, indicator, container) {
            // Create container div for this indicator
            const chartDiv = document.createElement('div');
            chartDiv.className = 'mt-2';
            chartDiv.innerHTML = `
                <h6>${indicator.name}</h6>
                <div id="${chartKey}" style="height: 200px;"></div>
            `;
            container.appendChild(chartDiv);

            // Determine color
            let color = '#45B7D1'; // Blue
            if (chartKey.includes('decayed')) {
                color = '#ffc107'; // Yellow/amber for decayed
            } else if (chartKey.includes('bar_score')) {
                color = '#17a2b8'; // Teal for bar scores
            } else if (chartKey.includes('raw')) {
                color = '#28a745'; // Green for raw
            }

            charts[chartKey] = Highcharts.stockChart(chartKey, {
                title: {
                    text: indicator.name,
                    style: { fontSize: '12px' }
                },

                rangeSelector: {
                    enabled: false
                },

                yAxis: {
                    title: {
                        text: 'Value'
                    },
                    plotLines: [{
                        value: 0,
                        color: '#666',
                        dashStyle: 'shortdash',
                        width: 1
                    }]
                },

                xAxis: {
                    events: {
                        afterSetExtremes: function(e) {
                            syncAllCharts(e, chartKey);
                        }
                    }
                },

                plotOptions: {
                    line: {
                        dataGrouping: { enabled: false },
                        lineWidth: 2
                    }
                },

                series: [{
                    name: indicator.name,
                    data: indicator.data,
                    color: color,
                    lineWidth: 2,
                    tooltip: {
                        pointFormat: '<b>{series.name}:</b> {point.y:.4f}'
                    }
                }]
            });
        }

        // Sync all charts when one is zoomed
        function syncAllCharts(extremes, sourceChart) {
            if (!extremes || extremes.trigger === 'syncExtremes') return;

            Object.keys(charts).forEach(chartKey => {
                if (chartKey !== sourceChart && charts[chartKey]) {
                    try {
                        charts[chartKey].xAxis[0].setExtremes(
                            extremes.min,
                            extremes.max,
                            true,
                            false,
                            { trigger: 'syncExtremes' }
                        );
                    } catch (error) {
                        console.warn(`Error syncing chart ${chartKey}:`, error);
                    }
                }
            });
        }

        // Create time-decayed indicator charts
        function createTimeDecayedCharts(timeDecayedIndicators) {
            const container = document.getElementById('timeDecayedCharts');
            container.innerHTML = '';

            Object.keys(timeDecayedIndicators).forEach(indicatorName => {
                const indicator = timeDecayedIndicators[indicatorName];
                createSimpleIndicatorChart(`decayed_${indicatorName}`, indicator, container);
            });
        }

        // Create bar score charts
        function createBarScoreCharts(barScores) {
            const container = document.getElementById('barScoreCharts');
            container.innerHTML = '';

            Object.keys(barScores).forEach(barName => {
                const barScore = barScores[barName];
                createSimpleIndicatorChart(`bar_score_${barName}`, barScore, container);
            });
        }

        // Main visualization function
        async function visualizeIndicators() {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const configText = document.getElementById('indicatorConfig').value.trim();

            // Validation
            if (!ticker || !startDate || !endDate) {
                showStatus('Please fill in all required fields.', 'warning');
                return;
            }

            let indicatorConfig;
            try {
                indicatorConfig = JSON.parse(configText);
            } catch (e) {
                showStatus('Invalid JSON configuration. Please check your syntax.', 'danger');
                return;
            }

            if (!Array.isArray(indicatorConfig) || indicatorConfig.length === 0) {
                showStatus('Please specify at least one indicator in the configuration array.', 'warning');
                return;
            }

            // Show loading state
            showLoading(true);
            showStatus('Loading data and calculating indicators...', 'info');

            try {
                const response = await fetch('/api/visualize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        start_date: startDate,
                        end_date: endDate,
                        indicators: indicatorConfig
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Unknown error occurred');
                }

                // Create charts: Original working triggers + IndicatorProcessor data
                window.lastIndicatorData = result.data.indicators; // Store for trigger access
                createCandlestickChart(result.data, result.ticker);
                
                // Original working indicator charts (MACD, SMA with triggers)
                createIndicatorCharts(result.data.indicators);
                
                // NEW: Time-decayed charts (from IndicatorProcessor.indicators)
                if (result.data.time_decayed_indicators) {
                    createTimeDecayedCharts(result.data.time_decayed_indicators);
                }
                
                // NEW: Bar score charts (from IndicatorProcessor bar_scores)
                if (result.data.bar_scores) {
                    createBarScoreCharts(result.data.bar_scores);
                }

                // Show charts and hide welcome message
                document.getElementById('chartsContainer').style.display = 'block';
                document.getElementById('welcomeMessage').style.display = 'none';

                showStatus(
                    `Successfully loaded ${result.candle_count} candles for ${result.ticker} (${result.date_range})`,
                    'success'
                );

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Event listeners
        document.getElementById('visualizeBtn').addEventListener('click', visualizeIndicators);
        document.getElementById('loadExampleBtn').addEventListener('click', loadExampleConfig);

        // Allow Enter key to submit
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'TEXTAREA') {
                    visualizeIndicators();
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadExampleConfig();
        });
    </script>
</body>
</html>